const $$=(e,t=document)=>t.querySelector(e),$$$=(e,t=document)=>t.querySelectorAll(e),scheduleIdle=(e,t=200)=>"requestIdleCallback"in window?requestIdleCallback(e,{timeout:t}):setTimeout(e,Math.min(40,t)),scheduleRAF=e=>requestAnimationFrame(e),debounce=(e,t=150)=>{let a;return(...r)=>{clearTimeout(a),a=setTimeout(()=>e(...r),t)}},arraysEqual=(e,t)=>e.length===t.length&&e.every((e,a)=>e===t[a]),setText=(e,t)=>{e&&e.textContent!==t&&(e.textContent=t)},DOMCACHE=new Map,qsc=e=>(DOMCACHE.has(e)||DOMCACHE.set(e,$$(e)),DOMCACHE.get(e));let CRM_DATA=[],VIEW_DATA=[],VIEW_DEGREE=[],ACCOUNT_DATA;const compareState={range1:"last_7days",range2:"previous_7days",custom1:null,custom2:null,data1:null,data2:null};let MISA_TOKEN_READY=!1;function waitForOTP(){return new Promise((e,t)=>{let a=document.querySelector(".dom_accounts"),r=document.querySelector(".dom_accounts_overlay"),l=document.getElementById("view_report"),o=document.getElementById("access_token");if(!a||!l||!o||!r)return t("Kh\xf4ng t\xecm th·∫•y c\xe1c th\xe0nh ph·∫ßn UI OTP");a.classList.add("active"),r.classList.add("active");let i=()=>{let t=o.value.trim();if(!t){alert("Vui l\xf2ng nh·∫≠p OTP!");return}a.classList.remove("active"),r.classList.remove("active"),l.removeEventListener("click",i),e(t)};l.addEventListener("click",i)})}async function loginFlow(e,t){let a=new FormData;a.append("Username",e),a.append("Password",t);let r=await fetch("https://ideas.edu.vn/login_otp.php?step=login",{method:"POST",body:a}),l=await r.json();if(console.log("Step 1 response:",l),!l.Data?.AccessToken?.Token){if(l.Data?.User?.EmployeeCode)return console.log("Kh\xf4ng c\xf3 temp token, nh∆∞ng c\xf3 EmployeeCode ‚Üí qua Step 3"),await doStep3();throw Error("Kh\xf4ng nh·∫≠n ƒë∆∞·ª£c temp token v\xe0 kh\xf4ng c\xf3 EmployeeCode!")}let o=l.Data.AccessToken.Token,i=await waitForOTP(),n=new FormData;n.append("OTP",i),n.append("Token",o);let s=await fetch("https://ideas.edu.vn/login_otp.php?step=otp",{method:"POST",body:n}),c=await s.json();if(console.log("Step 2 response:",c),!c.Success)throw Error(c.UserMessage||"Login th·∫•t b·∫°i!");return await doStep3()}async function doStep3(){let e=await fetch("https://ideas.edu.vn/login_otp.php?step=crm",{method:"POST"}),t=await e.json();console.log("Step 3 response:",t);let a=t.Data?.token,r=t.Data?.refresh_token;if(!a)throw Error("Kh\xf4ng l·∫•y ƒë∆∞·ª£c token CRM!");return localStorage.setItem("misa_token",a),localStorage.setItem("misa_refresh_token",r),{token:a,refresh_token:r}}async function quickLogin(){let e=await fetch("https://ideas.edu.vn/login_otp.php?step=crm",{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json(),a=t?.Data?.token;return a?(localStorage.setItem("misa_token",a),console.log("‚úÖ Token quickLogin ƒë\xe3 ƒë∆∞·ª£c l∆∞u"),a):(console.warn("‚ö†Ô∏è Kh\xf4ng t\xecm th·∫•y token trong quickLogin:",t),null)}async function getToken(e,t,a=!1){if(!a){let r=localStorage.getItem("misa_token");if(r)return r;let l=await quickLogin();if(l)return l}let o=await loginFlow(e,t);if(o?.token)return o.token;let i=prompt("Nh·∫≠p token MISA:");if(!i)throw Error("Kh\xf4ng c\xf3 token MISA");return localStorage.setItem("misa_token",i),i}async function fetchLeadData(e,t,a){let r=`https://ideas.edu.vn/proxy_misa.php?from_date=${e}&to_date=${t}&token=${a}`;for(let l=1;l<=3;l++)try{let o=await fetch(r,{cache:"no-store"});if(401===o.status||403===o.status)return console.warn(`‚ùå Token b·ªã t·ª´ ch·ªëi (${o.status}) ·ªü l·∫ßn ${l}`),localStorage.removeItem("misa_token"),[];if(!o.ok){console.warn(`‚ö†Ô∏è L·ªói HTTP ${o.status}, th·ª≠ l·∫°i (${l}/3)`);continue}let i=await o.json();if(i?.data?.length)return console.log(`üì¶ Nh·∫≠n ${i.data.length} leads (attempt ${l})`),i.data;console.log(`‚ÑπÔ∏è Attempt ${l}: data r·ªóng, th·ª≠ l·∫°i ngay...`);continue}catch(n){console.error(`‚ö†Ô∏è L·ªói network attempt ${l}:`,n);continue}return console.error("‚ùå H·∫øt 3 l∆∞·ª£t g·ªçi m\xe0 kh\xf4ng c\xf3 d·ªØ li·ªáu h·ª£p l·ªá"),[]}async function fetchLeads(e,t){let a=null,r=null;try{if(MISA_TOKEN_READY)return a=await fetchLeadData(e,t,r=localStorage.getItem("misa_token")),console.log(`üìÖ Fetch range ${e} ‚Üí ${t}:`,a?.length||0,"leads"),document.querySelector(".loading")?.classList.remove("active"),Array.isArray(a)&&(CRM_DATA=a,localStorage.setItem("crm_latest_data",JSON.stringify({from:e,to:t,count:a.length,leads:a})),console.log("\uD83D\uDCBE ƒê\xe3 l∆∞u data m·ªõi nh·∫•t v\xe0o CRM_DATA & localStorage")),a?.length||alert("Kh\xf4ng c\xf3 d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n\xe0y!"),a||[];if(r=await getToken("numt@ideas.edu.vn","Ideas123456"),console.log("\uD83D\uDD11 Token hi·ªán t·∫°i:",r.slice(0,20)+"..."),a=await fetchLeadData(e,t,r),Array.isArray(a)&&0===a.length){console.warn("‚ö†Ô∏è Token local c\xf3 th·ªÉ h·∫øt h·∫°n ‚Üí th·ª≠ quickLogin..."),localStorage.removeItem("misa_token");let l=await quickLogin();l&&(a=await fetchLeadData(e,t,r=l))}if(a?.length||(console.warn("‚ö†Ô∏è quickLogin th·∫•t b·∫°i ‚Üí loginFlow OTP..."),localStorage.removeItem("misa_token"),a=await fetchLeadData(e,t,r=await getToken("numt@ideas.edu.vn","Ideas123456",!0))),Array.isArray(a)&&(MISA_TOKEN_READY=!0,console.log(`‚úÖ Token OK, ƒë\xe3 b·∫≠t MISA_TOKEN_READY`)),!a?.length)return console.log("‚ÑπÔ∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu (nh∆∞ng token h·ª£p l·ªá)."),[];console.log(`‚úÖ ƒê\xe3 t·∫£i ${a.length} leads`),CRM_DATA=a}catch(o){console.error("\uD83D\uDEA8 L·ªói fetchLeads:",o),alert("Kh\xf4ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn IDEAS CRM!")}return a||[]}function getTagsArray(e){return e?e.split(",").map(e=>e.trim().replace(/^0\.\s*/g,"")).filter(Boolean):[]}function getPrimaryTag(e,t){if(!e||0===e.length)return"Untag";for(let a of t)if(e.some(e=>e.includes(a)))return a;return"Untag"}const tagPriority=["Needed","Qualified","Considering","Bad timing","Unqualified","Junk","New","Untag",];let RAW_DATA=[],GROUPED={},leadChartInstance=null,currentTagFilter="Needed";const currentFilter={campaign:null,source:null,medium:null};async function main(){performance.mark("start_main");let e=document.querySelectorAll(".dom_dashboard .dom_fade_item"),t=getDateRange("last_7days"),a=document.querySelector(".dom_date");a.textContent=formatDisplayDate(t.from,t.to),document.querySelector(".loading")?.classList.add("active");let r=performance.now();RAW_DATA=await fetchLeads(t.from,t.to),console.log(`‚úÖ FetchLeads done in ${(performance.now()-r).toFixed(1)}ms`),await processAndRenderAll(RAW_DATA,!0),setupTimeDropdown(),setupCompareDropdowns(),setupAccountFilter(),setupClearFilter(),setupQualityFilter(),setupLeadSearch(),setupDropdowns(),setupTagClick(),initSaleDetailClose(),performance.mark("end_main"),console.log("‚è± Total main():",performance.measure("main_total","start_main","end_main")),document.querySelector(".loading")?.classList.remove("active"),e.forEach((e,t)=>{setTimeout(()=>{e.classList.add("show")},150*t)})}function generateAdvancedReport(e){if(!GROUPED||!Array.isArray(e)){console.warn("generateAdvancedReport: D·ªØ li·ªáu ƒë·∫ßu v\xe0o kh\xf4ng h·ª£p l·ªá.");return}let t=t=>{let a=e.filter(e=>(e.CustomField16Text||"").trim().toUpperCase()===t);return{data:a,grouped:processCRMData(a)}},a=t("IDEAS"),r=t("VTCI"),l=makeDeepReport(a.grouped,a.data,"IDEAS"),o=makeDeepReport(r.grouped,r.data,"VTCI"),i=document.querySelector(".dom_date")?.textContent?.trim()||"",n=document.querySelector(".dom_ai_report");if(!n)return console.warn("Kh\xf4ng t\xecm th·∫•y .dom_ai_report trong DOM.");let s=n.querySelector("h3");s&&(s.innerHTML=`
   <p><img src="./logotarget.png">
      <span>CRM LEAD REPORT </span></p>
      ${i?`<p class="report_time">${i}</p>`:""}
    `);let c=n.querySelector(".dom_ai_report_content");c&&(c.innerHTML=`
      <div class="ai_report_block ideas">
        <h4> <img src="https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"/>IDEAS - CRM Data</h4>
        <div class="ai_report_inner">${l}</div>
      </div>
      <div class="ai_report_block vtci">
        <h4> <img src="https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"/>VTCI - CRM Data</h4>
        <div class="ai_report_inner">${o}</div>
      </div>
    `),console.log("‚úÖ ƒê\xe3 render b\xe1o c\xe1o AI cho IDEAS & VTCI.")}async function generateSaleReportAI(e,t="SALE"){if(!Array.isArray(e)||!e.length){alert("‚ö†Ô∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu ƒë·ªÉ ph\xe2n t\xedch!");return}let a=processCRMData(e),r=makeSaleAIReport(a,e,t),l=document.querySelector(".dom_date")?.textContent?.trim()||"",o=document.querySelector(".dom_ai_report h3");o&&(o.innerHTML=`
    <p><img src="./logotarget.png">
      <span>REPORT ${t}</span></p>
      ${l?`<p class="report_time">${l}</p>`:""}
    `);let i=document.querySelector(".dom_ai_report_content");if(!i)return console.warn("Kh\xf4ng t\xecm th·∫•y .dom_ai_report_content");i.innerHTML=`
    <div class="ai_report_block sale active">
      <div class="ai_report_inner">${r}</div>
    </div>
  `,setTimeout(()=>{i.querySelectorAll(".fade_in_item").forEach((e,t)=>setTimeout(()=>e.classList.add("show"),200*t))},3e3),console.log(`‚úÖ ƒê\xe3 render b\xe1o c\xe1o AI cho ${t}`)}function makeSaleAIReport(e,t,a="SALE"){var r;if(!e?.byTag||!t?.length)return`<p class="warn">‚ö†Ô∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu cho ${a}.</p>`;let l=t.length,o=/Needed|Considering/i,i=t.filter(e=>o.test(e.TagMain)).length,n=(i/l*100).toFixed(1),s=[{match:/facebook|fb/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Logo_de_Facebook.png/1200px-Logo_de_Facebook.png"},{match:/google/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png"},{match:/tiktok/i,url:"https://www.logo.wine/a/logo/TikTok/TikTok-Icon-White-Dark-Background-Logo.wine.svg"},{match:/linkedin/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/LinkedIn_icon.svg/1024px-LinkedIn_icon.svg.png"},{match:/zalo/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Zalo_logo_2021.svg/512px-Zalo_logo_2021.svg.png"},{match:/ideas/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},{match:/vtci/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"},],c=(e="")=>{let t=e.toLowerCase();for(let a of s)if(a.match.test(t))return a.url;return"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},d=Object.entries(e.byTag).map(([e,t])=>({tag:e,count:t.length})).sort((e,t)=>t.count-e.count),u=d[0],p=d.map(e=>`<li>${e.tag}: <b>${e.count}</b> (${(e.count/l*100).toFixed(1)}%)</li>`).join(""),g=Object.entries(VIEW_DEGREE||{}).filter(([e,t])=>t>0).map(([e,t])=>`<li>${e}: <b>${t}</b> (${(t/l*100).toFixed(1)}%)</li>`).join(""),m=[];for(let[$,h]of Object.entries(e.byCampaign))for(let[f,y]of Object.entries(h))for(let[b,_]of Object.entries(y)){let v=_.length,C=_.filter(e=>o.test(e.TagMain)).length;m.push({campaign:$,source:f,medium:b,total:v,quality:C,qualityRate:C/v*100})}let w=m.reduce((e,t)=>t.total>e.total?t:e),T=m.filter(e=>e.total>5).sort((e,t)=>t.qualityRate-e.qualityRate).slice(0,3),k=Object.entries(e.byDate).map(([e,t])=>({d:e,total:t.total})).sort((e,t)=>e.d.localeCompare(t.d)),S=(l/(k.length||1)).toFixed(1);k.length>2&&(k.at(-1).total,k.at(-2).total);let A=k.reduce((e,t)=>t.total>e.total?t:e,{d:"",total:0}),L=[];n<20?L.push(`T·ª∑ l·ªá lead ch·∫•t l∆∞·ª£ng th·∫•p (${n}%) ‚Äî c·∫ßn c·∫£i thi·ªán quy tr\xecnh t∆∞ v·∫•n ho·∫∑c k·ªãch b·∫£n follow-up.`):n<45?L.push(`T·ª∑ l·ªá lead trung b\xecnh (${n}%) ‚Äî c\xf3 th·ªÉ t·ªëi ∆∞u th\xeam n·ªôi dung t∆∞ v·∫•n ho·∫∑c th·ªùi gian ph·∫£n h·ªìi.`):L.push(`T·ª∑ l·ªá lead ch·∫•t l∆∞·ª£ng cao (${n}%) ‚Äî hi·ªáu su·∫•t t∆∞ v·∫•n ƒëang r·∫•t t·ªët.`),L.push(`Ng\xe0y cao ƒëi·ªÉm: <b>${A.d||"N/A"}</b> (${A.total} leads).`),T[0]&&L.push(`Chi·∫øn d·ªãch hi·ªáu qu·∫£ nh·∫•t: <b>${T[0].campaign}</b> (${T[0].qualityRate.toFixed(1)}% Qualified).`);let q=L.map(e=>`<li>${e}</li>`).join(""),D=(e,t)=>`
    <li>
      <div class="camp_item">
        <div class="camp_logo"><img src="${c(e.campaign+e.source)}" alt=""></div>
        <div class="camp_info">
          <p class="camp_name"><strong>${t+1}. ${e.campaign}</strong></p>
          <p class="camp_source">${e.source} / ${e.medium}</p>
        </div>
        <div class="camp_stats">
          <span class="camp_total">${e.total}</span> leads
          <span class="camp_quality">(${e.qualityRate.toFixed(1)}% Qualified)</span>
        </div>
      </div>
    </li>`;return`
  <section class="ai_section fade_in_block">
    <h5 class="fade_in_item delay-1"><i class="fa-solid fa-users"></i> Lead Overview</h5>
    <ul class="fade_in_item delay-2">
      <li><strong>T·ªïng s·ªë lead:</strong> <b>${l.toLocaleString("vi-VN")}</b></li>
      <li><strong>Trung b\xecnh m·ªói ng\xe0y:</strong> <b>${S}</b></li>
      <li><strong>T·ª∑ l·ªá lead ch·∫•t l∆∞·ª£ng:</strong> <b>${n}%</b></li>
      <li><strong>Tag ph·ªï bi·∫øn nh·∫•t:</strong> <b>${u.tag}</b> (${(0,u.count/l*100).toFixed(1)}%)</li>
    </ul>

    <h5 class="fade_in_item delay-3"><i class="fa-solid fa-tags"></i> Ph\xe2n lo·∫°i Tag</h5>
    <ul class="fade_in_item delay-4">${p}</ul>

    <h5 class="fade_in_item delay-5"><i class="fa-solid fa-graduation-cap"></i> H·ªçc v·∫•n</h5>
    <ul class="fade_in_item delay-6">${g}</ul>

    <h5 class="fade_in_item delay-7"><i class="fa-solid fa-bullhorn"></i> Hi·ªáu qu·∫£ chi·∫øn d·ªãch</h5>
    <ul class="ai_campaign_list fade_in_item delay-8">
      <li class="camp_top_volume">
        <div class="camp_item top">
          <div class="camp_logo"><img src="${c(w.campaign+w.source)}" alt=""></div>
          <div class="camp_info">
            <p class="camp_name"><strong>Top Lead:</strong> ${w.campaign}</p>
            <p class="camp_source">${w.source} / ${w.medium}</p>
          </div>
          <div class="camp_stats">
            <span class="camp_total">${w.total}</span> leads
            <span class="camp_quality">(${w.qualityRate.toFixed(1)}% Qualified)</span>
          </div>
        </div>
      </li>
      <li><strong>Top chi·∫øn d·ªãch hi·ªáu qu·∫£ (Qualified%)</strong></li>
      ${T.map(D).join("")}
    </ul>

    <h5 class="fade_in_item delay-9"><i class="fa-solid fa-chart-line"></i> Ph\xe2n t\xedch & Nh·∫≠n ƒë·ªãnh</h5>
    <ul class="fade_in_item delay-10 insight_list">${q}</ul>
  </section>`}function setupSaleAIReportButton(){let e=document.querySelector(".ai_report_sale");if(!e)return console.warn("Kh\xf4ng t\xecm th·∫•y n\xfat .ai_report_sale");e.onclick=e=>{if(!Array.isArray(VIEW_DATA)||!VIEW_DATA.length){alert("‚ö†Ô∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu ƒë·ªÉ ph\xe2n t\xedch b\xe1o c\xe1o AI!");return}let t=document.querySelector(".saleperson_detail .dom_selected"),a=t?.textContent?.trim()||VIEW_DATA[0]?.OwnerIDText||"Sale";generateSaleReportAI(VIEW_DATA,a);let r=document.querySelector(".dom_ai_report");r&&(r.classList.add("active"),r.scrollTop=0)}}(async()=>{console.time("‚è± DOM Dashboard Loaded"),await main(),console.timeEnd("‚è± DOM Dashboard Loaded")})();const getInitials=(e="")=>{let t=e.trim().split(/\s+/);return((t.at(-1)?.[0]||"")+(t[0]?.[0]||"")).toUpperCase()},getColorFromName2=e=>{let t=0;for(let a=0;a<e.length;a++)t=e.charCodeAt(a)+((t<<5)-t);return`hsl(${Math.abs(t)%360},70%,65%)`};function makeDeepReport(e,t,a="ORG"){var r;if(!e?.byOwner||!t?.length)return`<p class="warn">‚ö†Ô∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu cho ${a}.</p>`;let l=t.length,o=Object.entries(e.byTag).map(([e,t])=>({tag:e,count:t.length})).sort((e,t)=>t.count-e.count),i=o[0],n=Object.entries(e.byDate).map(([e,t])=>({d:e,total:t.total})).sort((e,t)=>e.d.localeCompare(t.d)),s=n.length||1,c=(l/s).toFixed(1),d=s>2?n.at(-1).total>n.at(-2).total?"Lead ƒëang tƒÉng so v·ªõi h\xf4m qua.":"Lead gi·∫£m so v·ªõi h\xf4m qua.":"",u=[{match:/facebook|fb/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Logo_de_Facebook.png/1200px-Logo_de_Facebook.png"},{match:/google/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png"},{match:/tiktok/i,url:"https://www.logo.wine/a/logo/TikTok/TikTok-Icon-White-Dark-Background-Logo.wine.svg"},{match:/linkedin/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/LinkedIn_icon.svg/1024px-LinkedIn_icon.svg.png"},{match:/zalo/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Zalo_logo_2021.svg/512px-Zalo_logo_2021.svg.png"},{match:/Other - Web VTCI/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"},{match:/Other - Web IDEAS/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},],p=(e="")=>{let t=e.toLowerCase();for(let a of u)if(a.match.test(t))return a.url;return"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},g=/Needed|Considering/i,m=[];for(let[$,h]of Object.entries(e.byCampaign))for(let[f,y]of Object.entries(h))for(let[b,_]of Object.entries(y)){let v=0;for(let C of _)g.test(C.TagMain)&&v++;let w=_.length;m.push({campaign:$,source:f,medium:b,total:w,quality:v,qualityRate:v/w*100})}let T=m.reduce((e,t)=>t.total>e.total?t:e),k=m.filter(e=>e.total>5).sort((e,t)=>t.qualityRate-e.qualityRate).slice(0,3),S=Object.entries(e.byOwner).map(([e,t])=>{let a=Object.values(t.tags).flatMap(e=>e.leads).filter(e=>g.test(e.TagMain)).length;return{owner:e,total:t.total,quality:a,qualityRate:a/t.total*100}}),A=S.reduce((e,t)=>t.total>e.total?t:e),L=S.reduce((e,t)=>t.qualityRate>e.qualityRate?t:e),q=S.reduce((e,t)=>t.qualityRate<e.qualityRate?t:e),D=t.filter(e=>/junk|spam|test/i.test(e.TagMain)).length,x=(D/l*100).toFixed(1),E=(L.qualityRate-q.qualityRate).toFixed(1),I=n.reduce((e,t)=>t.total>e.total?t:e,{d:"",total:0}),R=l/s,F=n.reduce((e,t)=>e+Math.pow(t.total-R,2),0)/s,M=100-Math.min(100,Math.sqrt(F)/R*100),O=t.filter(e=>g.test(e.TagMain)).length,B=(O/l*100).toFixed(1),P=[];B<20?P.push(`T·ª∑ l·ªá lead t·ªïng th·ªÉ th·∫•p (${B}%) ‚Äî c·∫ßn xem l·∫°i t·ªáp ƒë·ªëi t∆∞·ª£ng qu·∫£ng c\xe1o.`):B<=45?P.push(`T·ª∑ l·ªá lead trung b\xecnh (${B}%) ‚Äî c\xf3 th·ªÉ c·∫£i thi·ªán th\xeam b·∫±ng t·ªëi ∆∞u k\xeanh qu·∫£ng c\xe1o.`):P.push(`T·ª∑ l·ªá lead ch·∫•t l∆∞·ª£ng cao (${B}%) ‚Äî d·ªØ li·ªáu hi·ªáu su·∫•t qu·∫£ng c\xe1o ƒëang t·ªët.`),x>15&&P.push(`Lead r\xe1c chi·∫øm ${x}% ‚Äî c·∫ßn ƒëi·ªÅu ch·ªânh target ho·∫∑c thay ƒë·ªïi chi·∫øn d·ªãch.`),P.push(`ƒê·ªô ch\xeanh l·ªách hi·ªáu su·∫•t gi·ªØa <strong>${L.owner} (${L.qualityRate.toFixed(1)}%)</strong> v\xe0 <strong>${q.owner} (${q.qualityRate.toFixed(1)}%)</strong> l\xe0 <strong>${E}%</strong>.`),P.push(`Ng\xe0y cao ƒëi·ªÉm: ${I.d} (${I.total} leads).`);let U="·ªïn ƒë·ªãnh t·ªët";if(M<50?U="ch∆∞a ·ªïn ƒë·ªãnh (dao ƒë·ªông m·∫°nh gi·ªØa c\xe1c ng\xe0y)":M<80&&(U="t∆∞∆°ng ƒë·ªëi ·ªïn ƒë·ªãnh"),P.push(`Ch·ªâ s·ªë ·ªïn ƒë·ªãnh chi·∫øn d·ªãch: <strong>${M.toFixed(1)}%</strong> ‚Äî ${U}.`),k[0]){let N=k[0];P.push(`Chi·∫øn d·ªãch hi·ªáu qu·∫£ nh·∫•t: <strong>${N.campaign}</strong> ‚Äî <strong>${N.qualityRate.toFixed(1)}% Qualified</strong> (${N.quality}/${N.total} leads ƒë·ªß chu·∫©n).`)}P.push(`Sale n·ªïi b·∫≠t: <strong>${L.owner}</strong> (${L.qualityRate.toFixed(1)}%).`);let W=P.map(e=>`<li>${e}</li>`).join(""),H=(e,t)=>`
    <li>
      <div class="camp_item">
        <div class="camp_logo"><img src="${p(e.campaign+e.source)}" alt=""></div>
        <div class="camp_info">
          <p class="camp_name"><strong>${t+1}. ${e.campaign}</strong></p>
          <p class="camp_source">${e.source} / ${e.medium}</p>
        </div>
        <div class="camp_stats">
          <span class="camp_total">${e.total}</span> leads
          <span class="camp_quality">(${e.qualityRate.toFixed(1)}% Qualified)</span>
        </div>
      </div>
    </li>`,V=(e,t)=>`
    <li>
      <div class="sale_item">
        <div class="sale_avatar" style="background:${getColorFromName2(e.owner)}">${getInitials(e.owner)}</div>
        <div class="sale_info">
          <p><strong>${t}:</strong> ${e.owner}</p>
          <p class="sale_stats">${e.total} leads ‚Äì ${e.qualityRate.toFixed(1)}% Qualified</p>
        </div>
      </div>
    </li>`;return`
  <section class="ai_section fade_in_block">
    <h5 class="fade_in_item delay-1"><i class="fa-solid fa-users"></i> Lead</h5>
    <ul class="fade_in_item delay-2">
      <li><strong><i class="fa-solid fa-caret-right"></i> T·ªïng s·ªë lead:</strong> <b>${l.toLocaleString("vi-VN")}</b></li>
      <li><strong><i class="fa-solid fa-caret-right"></i> Trung b\xecnh m·ªói ng\xe0y:</strong> <b>${c} leads/ng\xe0y</b></li>
      <li><strong><i class="fa-solid fa-caret-right"></i> T·ª∑ l·ªá lead ch·∫•t l∆∞·ª£ng:</strong> <b>${B}%</b></li>
      <li><strong><i class="fa-solid fa-caret-right"></i> Tag ph·ªï bi·∫øn nh·∫•t:</strong> <b>${i.tag} (${(0,i.count/l*100).toFixed(1)}%)</b></li>
    </ul>

    <h5 class="fade_in_item delay-3"><i class="fa-solid fa-bullhorn"></i> Hi·ªáu qu·∫£ chi·∫øn d·ªãch</h5>
    <ul class="ai_campaign_list fade_in_item delay-4">
      <li class="camp_top_volume">
        <div class="camp_item top">
          <div class="camp_logo"><img src="${p(T.campaign+T.source)}" alt=""></div>
          <div class="camp_info">
            <p class="camp_name"><strong>Top Lead:</strong> ${T.campaign}</p>
            <p class="camp_source">${T.source} / ${T.medium}</p>
          </div>
          <div class="camp_stats">
            <span class="camp_total">${T.total}</span> leads
            <span class="camp_quality">(${T.qualityRate.toFixed(1)}% Qualified)</span>
          </div>
        </div>
      </li>
      <li><strong>Top chi·∫øn d·ªãch hi·ªáu qu·∫£ (Qualified%)</strong></li>
      ${k.map(H).join("")}
    </ul>

    <h5 class="fade_in_item delay-5"><i class="fa-solid fa-user-tie"></i> ƒê·ªôi ng≈© Sale</h5>
    <ul class="ai_sale_list fade_in_item delay-6">
      ${V(A,"Nhi·ªÅu lead nh·∫•t")}
      ${V(L,"Ch·∫•t l∆∞·ª£ng cao nh·∫•t")}
    </ul>

    <h5 class="fade_in_item delay-7"><i class="fa-solid fa-chart-line"></i> Xu h∆∞·ªõng</h5>
    <p class="fade_in_item delay-8">${d}</p>

    <h5 class="fade_in_item delay-9"><i class="fa-solid fa-chart-simple"></i> Ph\xe2n t\xedch & Nh·∫≠n ƒë·ªãnh</h5>
    <ul class="fade_in_item delay-10 insight_list">${W}</ul>
  </section>`}async function processAndRenderAll(e,t){VIEW_DATA=e,e?.length&&(GROUPED=await processCRMData(e),t&&(ACCOUNT_DATA=GROUPED),scheduleIdle(()=>renderChartsSmoothly(GROUPED),80),scheduleRAF(()=>{renderLeadTable(e),renderFilterOptions(GROUPED),renderSaleFilter(GROUPED)}),qsc(".loading")?.classList.remove("active"))}function renderChartsSmoothly(e){let t=[()=>renderLeadTrendChart(e),()=>renderLeadQualityMeter(e),()=>renderCampaignPieChart(e),()=>renderToplist(e),()=>renderToplistBySale(e),()=>renderTagFrequency(e),()=>renderProgramChart(e),()=>renderLeadTagChart(e),()=>renderDegreeChart(e),],a=0,r=()=>{if(a>=t.length)return;let e=t[a++];scheduleIdle(()=>{e(),scheduleRAF(r)})};queueMicrotask(()=>{t[0]?.(),a=1,r()})}function processCRMData(e){if(!e?.length)return{byDate:Object.create(null),byCampaign:Object.create(null),byOwner:Object.create(null),byTag:Object.create(null),byTagAndDate:Object.create(null),byOrg:Object.create(null),tagFrequency:Object.create(null)};let t={byDate:Object.create(null),byCampaign:Object.create(null),byOwner:Object.create(null),byTag:Object.create(null),byTagAndDate:Object.create(null),byOrg:Object.create(null),tagFrequency:Object.create(null)},a=e.length,r=tagPriority||[],l=getTagsArray,o=getPrimaryTag,i=0,n=()=>{let s=Math.min(i+4e3,a);for(;i<s;i++){let c=e[i],d=c.CreatedDate?c.CreatedDate.slice(0,10):"Unknown",u=l(c.TagIDText),p=o(u,r)||"Untag";"Qualified"===p&&(p="Needed"),0===u.length&&u.push("Untag"),c.TagMain=p;let g=c.CustomField16Text||"Org",m=c.CustomField13Text||"Campaign",$=c.CustomField14Text||"Source",h=c.CustomField15Text||"Medium",f=(c.OwnerIDText||"No Owner").replace(/\s*\(NV.*?\)\s*/gi,"").trim();for(let y=0;y<u.length;y++)t.tagFrequency[u[y]]=(t.tagFrequency[u[y]]||0)+1;let b=t.byDate[d]||={total:0};b.total++,b[p]=(b[p]||0)+1,(t.byTag[p]||=[]).push(c),((t.byTagAndDate[p]||=Object.create(null))[d]||=[]).push(c),(((t.byCampaign[m]||=Object.create(null))[$]||=Object.create(null))[h]||=[]).push(c);let _=t.byOwner[f]||={total:0,tags:Object.create(null),leads:[]};_.total++,_.leads.push(c);let v=_.tags[p]||={count:0,leads:[]};v.count++,v.leads.push(c);let C=t.byOrg[g]||={total:0,tags:Object.create(null),owners:Object.create(null),byDate:Object.create(null)};C.total++,(C.tags[p]||=[]).push(c),(C.owners[f]||=[]).push(c),(C.byDate[d]||=[]).push(c)}i<a&&scheduleIdle(n,60)};return n(),t}function resetToFirstMenu(){let e=document.querySelectorAll(".dom_menu li"),t=document.querySelector(".dom_container");if(!e.length||!t)return;e.forEach(e=>e.classList.remove("active"));let a=e[0];a.classList.add("active"),t.classList.forEach(e=>{["dashboard","sale","compare","won"].includes(e)&&t.classList.remove(e)});let r=a.getAttribute("data-view");r&&t.classList.add(r)}function renderSaleFilter(e){setupSaleQualityDropdown(e),setupLeadTagChartBySale(e),renderToplistBySale(e),renderLeadSaleChart(e,"Needed")}function renderFilterOptions(e){let t=qsc(".dom_select.campaign ul.dom_select_show"),a=qsc(".dom_select.source ul.dom_select_show"),r=qsc(".dom_select.medium ul.dom_select_show");if(!t||!a||!r)return;t.innerHTML="",a.innerHTML="",r.innerHTML="";let l=document.createDocumentFragment();for(let[o,i]of Object.entries(ACCOUNT_DATA.byCampaign||{})){let n=Object.values(i).flatMap(e=>Object.values(e)).flat().length,s=document.createElement("li");s.innerHTML=`<span class="radio_box"></span><span><span>${o}</span><span class="count">${n}</span></span>`,s.onclick=()=>applyFilter("campaign",o),l.appendChild(s)}t.appendChild(l);let c=Object.create(null);for(let d of Object.values(e.byCampaign||{}))for(let[u,p]of Object.entries(d))c[u]=(c[u]||0)+Object.values(p).flat().length;let g=document.createDocumentFragment();for(let[m,$]of Object.entries(c)){let h=document.createElement("li");h.innerHTML=`<span class="radio_box"></span><span><span>${m}</span><span class="count">${$}</span></span>`,h.onclick=()=>applyFilter("source",m),g.appendChild(h)}a.appendChild(g);let f=Object.create(null);for(let y of Object.values(e.byCampaign||{}))for(let b of Object.values(y))for(let[_,v]of Object.entries(b))f[_]=(f[_]||0)+v.length;let C=document.createDocumentFragment();for(let[w,T]of Object.entries(f)){let k=document.createElement("li");k.innerHTML=`<span class="radio_box"></span><span><span>${w}</span><span class="count">${T}</span></span>`,k.onclick=()=>applyFilter("medium",w),C.appendChild(k)}r.appendChild(C)}function setupQualityFilter(){let e=document.querySelector(".dom_select.quality");if(!e)return;e.querySelector(".flex");let t=e.querySelector("ul.dom_select_show"),a=e.querySelector(".dom_selected"),r=t.querySelectorAll("li");e.onclick=e=>{e.stopPropagation();let a=t.classList.contains("active");document.querySelectorAll(".dom_select_show").forEach(e=>e!==t&&e.classList.remove("active")),t.classList.toggle("active",!a)},r.forEach(e=>{e.onclick=l=>{l.stopPropagation();let o=e.querySelector("span:nth-child(2)").textContent.trim(),i=e.classList.contains("active");if(i){t.classList.remove("active");return}r.forEach(e=>e.classList.remove("active")),t.querySelectorAll(".radio_box").forEach(e=>e.classList.remove("active")),e.classList.add("active"),e.querySelector(".radio_box").classList.add("active"),a.textContent=o,renderLeadTrendChart(GROUPED,o),t.classList.remove("active")}}),document.addEventListener("click",a=>{e.contains(a.target)||t.classList.remove("active")})}function renderSourceAndMedium(e=null){let t=document.querySelector(".dom_select.source ul.dom_select_show"),a=document.querySelector(".dom_select.medium ul.dom_select_show");t.innerHTML="",a.innerHTML="";let r=e?{[e]:grouped.byCampaign[e]}:grouped.byCampaign,l={},o={};for(let i of Object.values(r))for(let[n,s]of Object.entries(i))for(let[c,d]of(l[n]=(l[n]||0)+Object.values(s).flat().length,Object.entries(s)))o[c]=(o[c]||0)+d.length;for(let[u,p]of Object.entries(l)){let g=document.createElement("li");g.innerHTML=`
        <span class="radio_box"></span>
       <span>
        <span>${u}</span>
        <span class="count">${p}</span>
       </span>`,g.onclick=()=>{applyFilter("source",u),renderMedium(e,u)},t.appendChild(g)}for(let[m,$]of Object.entries(o)){let h=document.createElement("li");h.innerHTML=`
        <span class="radio_box"></span>
       <span> <span>${m}</span>
        <span class="count">${$}</span></span>`,h.onclick=()=>applyFilter("medium",m),a.appendChild(h)}}function renderMedium(e,t){let a=document.querySelector(".dom_select.medium ul.dom_select_show");a.innerHTML="";let r=e?grouped.byCampaign[e]:grouped.byCampaign;t&&r[t];let l={};if(currentFilter.source&&!currentFilter.campaign)for(let o of Object.values(GROUPED.byCampaign)){if(!o[currentFilter.source])continue;let i=o[currentFilter.source];for(let[n,s]of Object.entries(i))l[n]=(l[n]||0)+s.length}else for(let c of Object.values(GROUPED.byCampaign))for(let d of Object.values(c))for(let[u,p]of Object.entries(d))l[u]=(l[u]||0)+p.length;for(let[g,m]of Object.entries(l)){let $=document.createElement("li");$.innerHTML=`
      <span class="radio_box"></span>
      <span><span>${g}</span>
      <span class="count">${m}</span></span>`,$.onclick=()=>applyFilter("medium",g),a.appendChild($)}}function setActiveRadio(e,t){let a=document.querySelector(`.dom_select.${e} ul.dom_select_show`);a.querySelectorAll("li").forEach(e=>{let a=e.querySelector("span:nth-child(2)").textContent,r=e.querySelector(".radio_box"),l=a===t;e.classList.toggle("active",l),r.classList.toggle("active",l)})}function applyFilter(e,t){currentFilter[e]=t,"campaign"===e&&(currentFilter.source=null,currentFilter.medium=null),"source"===e&&(currentFilter.medium=null),setText(qsc(`.dom_select.${e} .dom_selected`),t),setActiveRadio(e,t),setSourceActive?.();let a=filterLeadsBySelection(RAW_DATA);scheduleRAF(()=>processAndRenderAll(a))}function setupLeadSearch(){let e=qsc(".dom_search"),t=qsc("#find_data");if(!e||!t)return;let a=()=>{let t=e.value.trim().toLowerCase();if(!t){renderLeadTable(RAW_DATA);return}let a=RAW_DATA.filter(e=>{let a=(e.Mobile||"").toLowerCase(),r=(e.OwnerIDText||"").toLowerCase();return a.includes(t)||r.includes(t)});if(renderLeadTable(a),!a.length){let r=qsc(".dom_table_box");r&&(r.innerHTML=`<div class="dom_table_container empty"><p>Kh\xf4ng t\xecm th·∫•y d·ªØ li·ªáu ph\xf9 h·ª£p cho "<b>${t}</b>"</p></div>`)}},r=debounce(a,180);t.onclick=a,e.addEventListener("input",r,{passive:!0}),e.addEventListener("keypress",e=>{"Enter"===e.key&&a()},{passive:!0})}function setupLeadTagChartBySale(e){let t=document.querySelector(".dom_select.sale_tag_chart");if(!t)return;let a=t.querySelector(".dom_select_show"),r=t.querySelector(".dom_selected"),l=document.querySelector(".dom_search");if(!e?.byOwner)return;let o=Object.keys(e.byOwner).map(e=>e.replace(/\s*\(NV.*?\)/gi,"").trim()),i=o[0];a.innerHTML=o.map(e=>`
      <li class="${e===i?"active":""}">
        <span class="radio_box ${e===i?"active":""}"></span>
        <span>${e}</span>
      </li>
    `).join(""),r.textContent=i,renderLeadTagChartBySale(e,i);let n=t.querySelector(".flex");n.dataset.bound||(n.dataset.bound="1",n.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".dom_select_show.active").forEach(e=>{e!==a&&e.classList.remove("active")}),a.classList.toggle("active")})),a.dataset.bound||(a.dataset.bound="1",a.addEventListener("click",t=>{let o=t.target.closest("li");if(!o)return;a.querySelectorAll("li").forEach(e=>e.classList.remove("active")),a.querySelectorAll(".radio_box").forEach(e=>e.classList.remove("active")),o.classList.add("active"),o.querySelector(".radio_box").classList.add("active");let i=o.querySelector("span:nth-child(2)").textContent.trim();r.textContent=i,renderLeadTagChartBySale(e,i),l&&(l.value=i);let n=RAW_DATA.filter(e=>{let t=e.OwnerIDText?.toLowerCase()||"";return t.includes(i.toLowerCase())});renderLeadTable(n),a.classList.remove("active")})),document._saleTagOutside||(document.addEventListener("click",e=>{t.contains(e.target)||a.classList.remove("active")}),document._saleTagOutside=!0)}function renderLeadTagChartBySale(e,t){let a=document.getElementById("leadTagChartbySale");if(!a)return;let r=Object.keys(e.byOwner||{}).find(e=>e.replace(/\s*\(NV.*?\)/gi,"").trim()===t),l=r?e.byOwner[r]:null;if(!l)return;let o=["Considering","Needed","Bad timing","Unqualified","Junk","New","Untag",],i=[],n=[];for(let s=0;s<o.length;s++){let c=o[s],d=l.tags?.[c]?.count||0;d>0&&(i.push(c),n.push(d))}let u=Math.max(...n),p=n.map(e=>e===u?"#ffa900":"#d9d9d9"),g=window.leadTagChartBySaleInstance;if(g){let m=g.data.datasets[0];if(arraysEqual(g.data.labels,i)&&arraysEqual(m.data,n))return;g.data.labels=i,m.data=n,m.backgroundColor=p,m.borderColor=p,m.label=`Leads by Tag (${t})`,g.update("active");return}window.leadTagChartBySaleInstance=new Chart(a,{type:"bar",data:{labels:i,datasets:[{label:`Leads by Tag (${t})`,data:n,backgroundColor:p,borderColor:p,borderWidth:1,borderRadius:6,barPercentage:1,categoryPercentage:.5},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:300,easing:"easeOutQuad"},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.y.toLocaleString()} leads`}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},color:"#333",formatter:e=>e>0?e:""}},scales:{x:{grid:{display:!0,color:"rgb(240,240,240)",drawTicks:!1,drawBorder:!1},ticks:{font:{size:12},color:"rgb(85,85,85)"}},y:{beginAtZero:!0,ticks:{font:{size:11},color:"rgb(102,102,102)",stepSize:Math.ceil(u/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e},afterDataLimits:e=>e.max*=1.1,grid:{color:"rgb(240,240,240)"}}}},plugins:[ChartDataLabels]})}function filterLeadsBySelection(e){return e.filter(e=>{let t=e.CustomField13Text||"Campaign",a=e.CustomField14Text||"Source",r=e.CustomField15Text||"Medium";return(!currentFilter.campaign||currentFilter.campaign===t)&&(!currentFilter.source||currentFilter.source===a)&&(!currentFilter.medium||currentFilter.medium===r)})}function updateLeadCounters(e,t=currentTagFilter){if(!e||!e.byTag)return;let a=Object.values(e.byDate).reduce((e,t)=>e+(t.total||0),0),r=e.byTag[t]?e.byTag[t].length:0,l=a>0?(r/a*100).toFixed(1):0,o=document.getElementById("count_lead"),i=document.getElementById("count_needed");o&&(o.querySelector("span").textContent=`${a.toLocaleString()}`),i&&(i.querySelector("span").textContent=`${r.toLocaleString()} (${l}%) ${t}`)}function setupClearFilter(){let e=document.querySelector(".clear_filter");e&&(e.onclick=()=>{currentFilter.campaign=null,currentFilter.source=null,currentFilter.medium=null;let e=document.querySelector(".dom_filter");e&&["campaign","source","medium"].forEach(t=>{let a=e.querySelector(`.dom_select.${t}`);if(!a)return;let r=a.querySelector(".dom_selected");r&&("campaign"===t&&(r.textContent="All campaign"),"source"===t&&(r.textContent="All Source"),"medium"===t&&(r.textContent="All Medium")),a.querySelectorAll("li.active").forEach(e=>e.classList.remove("active")),a.querySelectorAll(".radio_box.active").forEach(e=>e.classList.remove("active"))});let t=localStorage.getItem("selectedAccount")||"Total Data",a=RAW_DATA;"VTCI"===t?a=RAW_DATA.filter(e=>"VTCI"==e.CustomField16Text?.trim().toUpperCase()):"IDEAS"===t&&(a=RAW_DATA.filter(e=>"IDEAS"==e.CustomField16Text?.trim().toUpperCase())),setActiveAccountUI(t),processAndRenderAll(a)})}function formatDisplayDate(e,t){let a=new Date(e),r=new Date(t),l=e=>`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()}`;return`${l(a)} - ${l(r)}`}function getDateRange(e){let t=new Date;t.setHours(0,0,0,0);let a=new Date(t);a.setDate(t.getDate()-(t.getDay()+6)%7);let r,l;switch(e){case"this_week":r=new Date(a),(l=new Date(a)).setDate(r.getDate()+6);break;case"last_week":(r=new Date(a)).setDate(r.getDate()-7),(l=new Date(r)).setDate(r.getDate()+6);break;case"this_month":r=new Date(t.getFullYear(),t.getMonth(),1),l=new Date(t.getFullYear(),t.getMonth()+1,0);break;case"last_7days":(l=new Date(t)).setDate(t.getDate()-1),(r=new Date(l)).setDate(l.getDate()-6);break;case"previous_7days":(l=new Date(t)).setDate(t.getDate()-8),(r=new Date(l)).setDate(l.getDate()-6);break;case"yesterday":(r=new Date(t)).setDate(t.getDate()-1),l=new Date(r);break;default:r=new Date(t),l=new Date(t)}let o=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;return{from:o(r),to:o(l)}}function setActiveAccountUI(e){let t=document.querySelector(".dom_account_view_block .account_item");if(!t)return;let a={VTCI:{img:"https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"},IDEAS:{img:"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},"Total Data":{img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRlIpztniIEN5ZYvLlwwqBvhzdodvu2NfPSbg&s"}},r=a[e]||a["Total Data"],l=t.querySelector(".account_item_avatar"),o=t.querySelector(".account_item_name");l.src=r.img,o.textContent=e,document.querySelectorAll(".dom_account_view ul li").forEach(t=>{let a=t.querySelector("p span:first-child")?.textContent.trim();a===e?t.style.display="none":t.style.display=""})}function clearAllDropdownFilters(){console.log("\uD83E\uDDF9 Reset filter dropdown (campaign/source/medium)"),currentFilter.campaign=null,currentFilter.source=null,currentFilter.medium=null;let e=document.querySelector(".dom_filter");e&&["campaign","source","medium"].forEach(t=>{let a=e.querySelector(`.dom_select.${t}`);if(!a)return;let r=a.querySelector(".dom_selected");r&&("campaign"===t&&(r.textContent="All campaign"),"source"===t&&(r.textContent="All Source"),"medium"===t&&(r.textContent="All Medium")),a.querySelectorAll("li.active, .radio_box.active").forEach(e=>e.classList.remove("active"))})}function setupAccountFilter(){let e=document.querySelector(".dom_account_view");if(!e)return;let t=e.querySelector(".dom_account_view_block .account_item"),a=e.querySelector("ul"),r=e.querySelectorAll("ul li");localStorage.setItem("selectedAccount","Total Data"),setActiveAccountUI("Total Data"),t.onclick=e=>{e.stopPropagation(),a.classList.toggle("active")},r.forEach(e=>{e.onclick=async t=>{t.stopPropagation();let r=e.querySelector("p span:first-child").textContent.trim(),l=RAW_DATA;if("VTCI"===r?l=RAW_DATA.filter(e=>"VTCI"===e.CustomField16Text?.trim().toUpperCase()):"IDEAS"===r&&(l=RAW_DATA.filter(e=>"IDEAS"===e.CustomField16Text?.trim().toUpperCase())),!l?.length){alert(`‚ö†Ô∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu cho account "${r}", vui l\xf2ng ch·ªçn kho·∫£ng th·ªùi gian kh\xe1c!`),console.warn(`‚ö†Ô∏è Account ${r} kh\xf4ng c\xf3 d·ªØ li·ªáu, gi·ªØ nguy\xean dashboard.`),a.classList.remove("active");return}localStorage.setItem("selectedAccount",r),a.classList.remove("active"),clearAllDropdownFilters(),console.log(`‚úÖ ${l.length} leads thu·ªôc account ${r}`),setActiveAccountUI(r),processAndRenderAll(l,!0),resetToFirstMenu()}}),document.addEventListener("click",t=>{e.contains(t.target)||a.classList.remove("active")})}function setupTimeDropdown(){let e=document.querySelector(".dom_select.time");if(!e)return;let t=e.querySelector(".flex"),a=e.querySelector(".dom_select_show"),r=e.querySelector(".dom_selected"),l=document.querySelector(".dom_date"),o=e.querySelector(".apply_custom_date"),i=e.querySelector(".custom_date"),n=a.querySelectorAll("li");t.onclick=e=>{e.stopPropagation(),document.querySelectorAll(".dom_select_show").forEach(e=>e!==a&&e.classList.remove("active")),a.classList.toggle("active")},n.forEach(e=>{e.onclick=async t=>{t.stopPropagation();let o=e.dataset.date;if("custom_range"===o){n.forEach(e=>e.classList.remove("active")),e.classList.add("active"),i.classList.add("show");return}n.forEach(e=>e.classList.remove("active")),e.classList.add("active"),i.classList.remove("show");let s=e.querySelector("span:last-child").textContent.trim();r.textContent=s;let c=getDateRange(o);l.textContent=formatDisplayDate(c.from,c.to),document.querySelector(".loading")?.classList.add("active"),RAW_DATA=await fetchLeads(c.from,c.to),localStorage.setItem("selectedAccount","Total Data"),setActiveAccountUI("Total Data"),processAndRenderAll(RAW_DATA,!0),a.classList.remove("active")}}),o.onclick=async e=>{e.stopPropagation();let t=document.getElementById("start").value,o=document.getElementById("end").value;if(!t||!o)return alert("‚ö†Ô∏è Vui l\xf2ng ch·ªçn ƒë·ªß ng\xe0y b·∫Øt ƒë·∫ßu v\xe0 k·∫øt th\xfac!");let n=new Date(t),s=new Date(o),c=new Date("2025-10-01");return n<c?alert("‚ö†Ô∏è Ng\xe0y b·∫Øt ƒë·∫ßu kh\xf4ng ƒë∆∞·ª£c tr∆∞·ªõc 01/10/2025!"):s<=n?alert("‚ö†Ô∏è Ng\xe0y k·∫øt th\xfac ph·∫£i sau ng\xe0y b·∫Øt ƒë·∫ßu!"):void(r.textContent="Custom Date",l.textContent=formatDisplayDate(t,o),document.querySelector(".loading")?.classList.add("active"),RAW_DATA=await fetchLeads(t,o),processAndRenderAll(RAW_DATA,!0),localStorage.setItem("selectedAccount","Total Data"),setActiveAccountUI("Total Data"),a.classList.remove("active"),i.classList.remove("show"))},document.addEventListener("click",t=>{e.contains(t.target)||a.classList.remove("active")})}function setupDropdowns(){let e=".dom_select.saleperson_detail, .dom_select.campaign, .dom_select.source, .dom_select.medium",t=".dom_select.saleperson_detail .dom_select_show.active, .dom_select.campaign .dom_select_show.active, .dom_select.source .dom_select_show.active, .dom_select.medium .dom_select_show.active";document.querySelectorAll(".dom_select.saleperson_detail .dom_select_show, .dom_select.campaign .dom_select_show, .dom_select.source .dom_select_show, .dom_select.medium .dom_select_show").forEach(e=>e.classList.remove("active"));let a=document.querySelectorAll(e),r=!1;a.forEach(e=>{let a=e.querySelector(".flex"),l=e.querySelector(".dom_select_show");a&&l&&(a.dataset.dropdownBound||(a.dataset.dropdownBound="1",a.addEventListener("click",e=>{e.stopPropagation(),r||(document.querySelectorAll(t).forEach(e=>{e!==l&&e.classList.remove("active")}),l.classList.toggle("active"))})))}),window.__dropdownGlobalBound||(window.__dropdownGlobalBound=!0,document.addEventListener("click",a=>{if(r)return;let l=a.target.closest(".dom_select.saleperson_detail .dom_select_show li, .dom_select.campaign .dom_select_show li, .dom_select.source .dom_select_show li, .dom_select.medium .dom_select_show li");if(l){r=!0,setTimeout(()=>r=!1,200),document.querySelectorAll(t).forEach(e=>e.classList.remove("active"));return}a.target.closest(e)||document.querySelectorAll(t).forEach(e=>e.classList.remove("active"))}))}function renderLeadTagChart(e){let t=document.getElementById("leadTagChart"),a=document.getElementById("top_tag");if(!t||!e?.byTag)return;let r=Object.entries(e.byTag);if(!r.length)return;let l=[],o=[],i=0,n=0;for(let s=0;s<r.length;s++){let[c,d]=r[s],u=d.length;l.push(c),o.push(u),u>n&&(n=u,i=s)}let p=o.map((e,t)=>t===i?"#ffa900":"#d9d9d9");a&&(a.textContent=l[i]||"");let g=window.leadTagChartInstance;if(g){if(arraysEqual(g.data.datasets[0].data,o))return;g.data.labels=l,g.data.datasets[0].data=o,g.data.datasets[0].backgroundColor=p,g.data.datasets[0].borderColor=p,g.update();return}window.leadTagChartInstance=new Chart(t,{type:"bar",data:{labels:l,datasets:[{label:"Leads by Tag",data:o,backgroundColor:p,borderColor:p,borderWidth:1,borderRadius:6},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:400,easing:"easeOutCubic"},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.y.toLocaleString()} leads`}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{display:!1,drawBorder:!1},ticks:{font:{size:12},color:"#555"}},y:{beginAtZero:!0,ticks:{font:{size:11},color:"#666",stepSize:Math.ceil(n/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e},afterDataLimits:e=>e.max*=1.05,grid:{color:"rgba(0,0,0,0.04)"}}}},plugins:[ChartDataLabels]})}document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".dom_menu li"),t=document.querySelector(".dom_container");e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),a.classList.add("active"),t.classList.forEach(e=>{["dashboard","sale","compare","won"].includes(e)&&t.classList.remove(e)});let r=a.getAttribute("data-view");t.classList.add(r)})})});let ORIGINAL_DATA=null;function mergeAllArrays(e){let t=[];for(let[a,r]of Object.entries(e))if(r&&"object"==typeof r)for(let l of Object.values(r))Array.isArray(l)&&t.push(...l);return t}function setSourceActive(){let e=document.querySelector(".btn-source"),t=document.querySelector(".btn-campaign");e&&t&&(t.classList.remove("active"),e.classList.add("active"))}function renderToplist(e,t="default"){let a=document.querySelector(".dom_toplist_wrap .dom_toplist"),r=document.querySelector(".dom_dashboard"),l=document.querySelector(".sale_report"),o=document.querySelector(".dom_date");if(!a||!e?.byCampaign)return;ORIGINAL_DATA||(ORIGINAL_DATA=RAW_DATA);let i=[];for(let[n,s]of Object.entries(e.byCampaign)){let c=0,d=0;for(let[u,p]of Object.entries(s))for(let[g,m]of Object.entries(p)){let $=m.length,h=m.filter(e=>"Needed"===e.TagMain).length,f=m.filter(e=>"Considering"===e.TagMain).length,y=h+f,b=$>0?y/$*100:0;c+=$,d+=y,"default"===t&&i.push({key:`${n} - ${u} - ${g}`,campaign:n,source:u,medium:g,total:$,quality:y,ratio:+b.toFixed(1)})}if("campaign"===t){let _=c>0?d/c*100:0;i.push({key:`${n}`,campaign:n,total:c,quality:d,ratio:+_.toFixed(1)})}}i.sort((e,t)=>t.total-e.total),a.innerHTML="";let v=[{match:/facebook|fb/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Logo_de_Facebook.png/1200px-Logo_de_Facebook.png"},{match:/google/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png"},{match:/tiktok/i,url:"https://www.logo.wine/a/logo/TikTok/TikTok-Icon-White-Dark-Background-Logo.wine.svg"},{match:/linkedin/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/LinkedIn_icon.svg/1024px-LinkedIn_icon.svg.png"},{match:/zalo/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Zalo_logo_2021.svg/512px-Zalo_logo_2021.svg.png"},{match:/Other - Web VTCI/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"},{match:/Other - Web IDEAS/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},];i.forEach(e=>{let t="rgb(0, 177, 72)";e.ratio<20?t="rgb(225, 112, 85)":e.ratio<40&&(t="rgb(255, 169, 0)");let r="https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp";for(let l of v)if(l.match.test(e.key)){r=l.url;break}let o=`
      <li data-campaign="${e.campaign}" data-source="${e.source||""}" data-medium="${e.medium||""}">
        <p><img src="${r}" /><span>${e.key}</span></p>
        <p><i class="fa-solid fa-user"></i><span class="total_lead">${e.total}</span></p>
        <p><i class="fa-solid fa-user-graduate"></i><span class="quality_lead">${e.quality}</span></p>
        <p class="toplist_percent" style="color:${t}; background:rgba(${t.replace("rgb(","").replace(")","")},0.1)">${e.ratio}%</p>
        <p class="toplist_more_ads" title="Xem chi ti·∫øt ${e.key}"><i class="fa-solid fa-magnifying-glass-chart main_clr"></i></p>
      </li>
    `;a.insertAdjacentHTML("beforeend",o)}),a.querySelectorAll(".toplist_more_ads").forEach(e=>{e.addEventListener("click",e=>{setSourceActive();let t=e.currentTarget.closest("li"),i=t.dataset.campaign,n=t.dataset.source,s=t.dataset.medium;if(i&&n&&s){let c=GROUPED.byCampaign[i][n][s];processAndRenderAll(c)}else if(i){let d=GROUPED.byCampaign[i],u=mergeAllArrays(d);processAndRenderAll(u)}r.classList.add("sale_detail_ads");let p=l.querySelector("img"),g=l.querySelector(".dom_selected"),m=l.querySelector(".sale_report_calender");p&&(p.src=t.querySelector("img").src),g&&(g.innerText=t.querySelector("span").innerText),m&&(m.innerText=o?.innerText||""),a.querySelectorAll("li").forEach(e=>e.classList.remove("active")),t.classList.add("active")})})}function setupSaleQualityDropdown(e){let t=document.querySelector(".dom_select.sale_quality");if(!t)return;let a=t.querySelector(".dom_selected"),r=t.querySelector(".dom_select_show"),l=t.querySelector(".flex");l.dataset.bound||(l.dataset.bound="1",l.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".dom_select_show.active").forEach(e=>{e!==r&&e.classList.remove("active")}),r.classList.toggle("active")})),r.querySelectorAll("li").forEach(e=>{let t=e.cloneNode(!0);e.parentNode.replaceChild(t,e)}),r.querySelectorAll("li").forEach(t=>{t.addEventListener("click",l=>{l.stopPropagation();let o=t.querySelector("span:nth-child(2)").textContent.trim();r.querySelectorAll("li").forEach(e=>e.classList.remove("active")),t.classList.add("active"),r.querySelectorAll(".radio_box").forEach(e=>e.classList.remove("active")),t.querySelector(".radio_box").classList.add("active"),a.textContent=o,renderLeadSaleChart(e,o),r.classList.remove("active")})}),document._saleQualityOutside||(document.addEventListener("click",e=>{t.contains(e.target)||r.classList.remove("active")}),document._saleQualityOutside=!0)}function renderCampaignPieChart(e){let t=document.getElementById("pieCampaign");if(!t)return;let a=[],r=[];for(let[l,o]of Object.entries(e.byCampaign)){let i=0;for(let n of Object.values(o))for(let s of Object.values(n))i+=s.length;a.push(l),r.push(i)}let c=["#ffa900","#262a53","#cccccc","#e17055","#74b9ff","#a29bfe","#55efc4","#fab1a0","#fdcb6e","#81ecec","#b2bec3"],d=a.map((e,t)=>c[t%c.length]+"cc"),u=a.map((e,t)=>c[t%c.length]),p=r.reduce((e,t)=>e+t,0);if(window.campaignPieInstance){let g=window.campaignPieInstance;g.data.labels=a,g.data.datasets[0].data=r,g.data.datasets[0].backgroundColor=d,g.data.datasets[0].borderColor=u,g.update("active");return}window.campaignPieInstance=new Chart(t,{type:"pie",data:{labels:a,datasets:[{label:"Campaign Share",data:r,backgroundColor:d,borderColor:u,borderWidth:1.5},]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:10},animation:{duration:900,easing:"easeOutQuart"},plugins:{legend:{position:"bottom",align:"center",labels:{boxWidth:8,padding:10,color:"#333",font:{size:11,weight:"500"}}},tooltip:{callbacks:{label(e){let t=e.parsed,a=p>0?(t/p*100).toFixed(1):0;return`${e.label}: ${t} (${a}%)`}}},datalabels:{color:"#fff",font:{size:10,weight:"600"},formatter(e){let t=p>0?(e/p*100).toFixed(1):0;return t>3?`${t}%`:""},anchor:"end",align:"end",offset:4,clip:!1}}},plugins:[ChartDataLabels]})}function renderLeadSaleChart(e,t="Needed"){if(!e?.byOwner)return;let a=document.getElementById("leadSale");if(!a)return;let r=Object.entries(e.byOwner),l=Array(r.length),o=Array(r.length),i=Array(r.length);for(let n=0;n<r.length;n++){let[s,c]=r[n];l[n]=s.replace(/\s*\(NV.*?\)/gi,"").trim(),o[n]=c.total||0,i[n]=c.tags?.[t]?.count||0}let d=Math.max(...o,...i),u="rgba(38,42,83,0.8)",p="rgba(255,171,0,0.8)",g=window.leadSaleChartInstance;if(g){let m=!1;arraysEqual(g.data.labels,l)||(g.data.labels=l,m=!0),arraysEqual(g.data.datasets[0].data,o)||(g.data.datasets[0].data=o,m=!0),arraysEqual(g.data.datasets[1].data,i)||(g.data.datasets[1].data=i,g.data.datasets[1].label=`${t} Leads`,m=!0),m&&g.update("active");return}window.leadSaleChartInstance=new Chart(a.getContext("2d"),{type:"bar",data:{labels:l,datasets:[{label:"Total Leads",data:o,backgroundColor:p,borderColor:p.replace("0.8","1"),borderWidth:1,borderRadius:5},{label:`${t} Leads`,data:i,backgroundColor:u,borderColor:u.replace("0.8","1"),borderWidth:1,borderRadius:5},]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{position:"top",align:"end"},tooltip:{callbacks:{label(e){let t=o[e.dataIndex]||0,a=e.parsed.y||0,r=t>0?(a/t*100).toFixed(1):0;return`${e.dataset.label}: ${a.toLocaleString()} leads (${r}%)`}}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#444",autoSkip:!0,maxTicksLimit:8}},y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#666",stepSize:Math.ceil(d/4)||1},afterDataLimits:e=>e.max*=1.1}}},plugins:[ChartDataLabels]})}function maskEmail(e){if(!e)return"-";let[t,a]=e.split("@");if(!a)return e;let r=t.slice(0,3);return`${r}......@${a}`}function maskMobile(e){if(!e)return"-";let t=e.slice(-4);return"*".repeat(Math.max(0,e.length-4))+t}function renderLeadTable(e){let t=document.querySelector(".dom_table_box");if(!t)return;if(!Array.isArray(e)||0===e.length){t.innerHTML='<div class="dom_table_container empty"><p>No data</p></div>';return}let a=["Created Date","Lead Name","Mobile","Owner","Tags","Campaign","Source","Medium","Organization","Description",];t.innerHTML=`
    <div class="dom_table_container scrollable">
      <table id="main_table">
        <thead><tr>${a.map(e=>`<th class="sortable">${e}</th>`).join("")}</tr></thead>
        <tbody></tbody>
        <tfoot><tr>
          <td colspan="3">View <span class="loaded_count">0</span> / ${e.length.toLocaleString()} leads</td>
          <td colspan="${a.length-3}"></td>
        </tr></tfoot>
      </table>
    </div>`;let r=t.querySelector("tbody"),l=t.querySelector(".loaded_count"),o=t.querySelector(".dom_table_container"),i=t.querySelectorAll("thead th"),n=0,s=!1,c=!1,d=e=>e?new Date(e).toLocaleDateString("vi-VN"):"-",u=(e="")=>{let t=String(e).replace(/\D/g,"");return t.length<=6?t:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢"+t.slice(-6)},p=(e="")=>e.trim()?e.split(",").map(e=>e.trim()).filter(Boolean).map(e=>{let t=/Needed/i.test(e)?"tag_needed":/Considering/i.test(e)?"tag_considering":/Bad timing/i.test(e)?"tag_bad":/Unqualified/i.test(e)?"tag_unqualified":/Junk/i.test(e)?"tag_junk":"tag_other";return`<span class="tag_chip ${t}">${e}</span>`}).join(" "):"-";function g(t){let a=Math.min(n+t,e.length),o="";for(let i=n;i<a;i++){let c=e[i];o+=`
        <tr data-id="${i}">
          <td>${d(c.CreatedDate)}</td>
          <td>${c.LeadName||"-"}</td>
          <td><i class="fa-solid fa-phone table_phone"></i> ${u(c.Mobile)}</td>
          <td>${c.OwnerIDText?.replace(/\s*\(NV.*?\)/gi,"").trim()||"-"}</td>
          <td>${p(c.TagIDText||"")}</td>
          <td>${c.CustomField13Text||"-"}</td>
          <td>${c.CustomField14Text||"-"}</td>
          <td>${c.CustomField15Text||"-"}</td>
          <td>${c.CustomField16Text||"-"}</td>
          <td>${c.Description||"-"}</td>
        </tr>`}r.insertAdjacentHTML("beforeend",o),n=a,l.textContent=n.toLocaleString("en-US"),s=!1}e.sort((e,t)=>(c?1:-1)*(new Date(e.CreatedDate||0)-new Date(t.CreatedDate||0))),g(20),o.addEventListener("scroll",()=>{if(s)return;let{scrollTop:t,scrollHeight:a,clientHeight:r}=o;a-t-r<200&&n<e.length&&(s=!0,requestAnimationFrame(()=>g(20)))},{passive:!0}),i.forEach(t=>{"Created Date"===t.textContent&&(t.classList.add("clickable"),t.innerHTML='Created Date <i class="fa-solid fa-sort"></i>',t.addEventListener("click",()=>{c=!c,e.sort((e,t)=>(c?1:-1)*(new Date(e.CreatedDate||0)-new Date(t.CreatedDate||0))),r.innerHTML="",n=0,g(20),l.textContent=n.toLocaleString("en-US"),o.scrollTop=0}))})}function setupTagClick(){let e=document.querySelector(".frequency_tag");e&&e.addEventListener("click",t=>{let a=t.target.closest(".freq_tag_item");if(!a||!e.contains(a))return;let r=a.querySelector(".tag_name")?.innerText.trim();if(!r)return;e.querySelectorAll(".freq_tag_item").forEach(e=>e.classList.remove("active")),a.classList.add("active");let l=RAW_DATA.filter(e=>{let t=e.TagIDText||"";return t.includes(r)});l.length?processAndRenderAll(l):console.warn(`Kh\xf4ng c\xf3 lead n\xe0o thu·ªôc tag "${r}"`);let o=document.querySelector(".dom_dashboard"),i=document.querySelector(".saleperson_detail"),n=document.querySelector(".saleperson_detail > img");o?.classList.add("sale_detail_ads"),i.querySelector(".dom_selected").innerText=r,n.src="./tag.png"})}function renderTagFrequency(e){let t=document.querySelector(".frequency_tag");if(!t||!e?.tagFrequency)return;let a=e.tagFrequency,r=new Set(["Needed","Considering","Bad timing","Status - Bad timing","Status - Junk","Qualified","Msc_AI UMEF","MBA UMEF","EMBA UMEF","Unqualified","Status - New","Junk","Untag","BBA",]),l=Object.entries(a).filter(([e])=>!r.has(e)).sort((e,t)=>t[1]-e[1]);if(t.textContent="",!l.length){t.innerHTML=`<p class="no_tag">Kh\xf4ng c\xf3 tag ph·ª• n\xe0o</p>`;return}let o=["#ffa900","#262a53","#cccccc","#e17055","#74b9ff","#a29bfe","#55efc4","#fab1a0","#fdcb6e",],i=o.length,n=l.map(([e,t],a)=>`
        <p class="freq_tag_item" style="--tag-color:${o[a%i]}">
          <span class="tag_dot" style="background:${o[a%i]}"></span>
          <span class="tag_name">${e}</span>
          <span class="tag_count">${t}</span>
        </p>`).join("");t.insertAdjacentHTML("beforeend",n)}function countDegrees(e){if(!Array.isArray(e))return{};let t={duoiCD:/(d∆∞·ªõi[\s_]*cao[\s_]*ƒë·∫≥ng|duoi[\s_]*cao[\s_]*dang)/i,caoDang:/(cao[\s_]*ƒë·∫≥ng|cao[\s_]*dang)/i,thpt:/thpt/i,sinhVien:/(sinh[\s_]*vi√™n|sinh[\s_]*vien|sinhvien)/i,cuNhan:/(c·ª≠[\s_]*nh√¢n|cu[\s_]*nhan)/i,thacSi:/(th·∫°c[\s_]*sƒ©|thac[\s_]*si)/i},a={"C·ª≠ nh\xe2n":0,"Cao ƒë·∫≥ng":0,"D∆∞·ªõi cao ƒë·∫≥ng":0,THPT:0,"Sinh vi\xean":0,"Th·∫°c sƒ©":0,Kh√°c:0},r=e.map(e=>e.Description?e.Description.toLowerCase():"");for(let l of r)l.trim()&&(t.duoiCD.test(l)?a["D∆∞·ªõi cao ƒë·∫≥ng"]++:t.caoDang.test(l)?a["Cao ƒë·∫≥ng"]++:t.thpt.test(l)?a.THPT++:t.cuNhan.test(l)?a["C·ª≠ nh\xe2n"]++:t.sinhVien.test(l)?a["Sinh vi\xean"]++:t.thacSi.test(l)?a["Th·∫°c sƒ©"]++:a["Kh\xe1c"]++);return a}function renderDegreeChart(e){let t=document.getElementById("degreeChart"),a=document.getElementById("top_edu");if(!t)return;let r=Array.isArray(e)?e:Object.values(e.byOwner||{}).flatMap(e=>e.leads||[]);if(!r.length)return;let l=countDegrees(r);VIEW_DEGREE=l;let o=Object.keys(l),i=Object.values(l),n=Math.max(...i),s=i.map(e=>e===n?"#ffa900":"#d9d9d9");a&&n>0&&(a.textContent=o[i.indexOf(n)]||"");let c=window.degreeChartInstance;if(c){arraysEqual(c.data.datasets[0].data,i)||(c.data.labels=o,c.data.datasets[0].data=i,c.data.datasets[0].backgroundColor=s,c.data.datasets[0].borderColor=s,c.update());return}window.degreeChartInstance=new Chart(t,{type:"bar",data:{labels:o,datasets:[{label:"S·ªë l∆∞·ª£ng Leads theo tr\xecnh ƒë·ªô h·ªçc v·∫•n",data:i,backgroundColor:s,borderColor:s,borderWidth:1,borderRadius:6},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:400,easing:"easeOutCubic"},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.y.toLocaleString()} Leads`}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{color:"rgba(0,0,0,0.05)",drawTicks:!1,drawBorder:!1},ticks:{font:{size:12},color:"#555"}},y:{beginAtZero:!0,ticks:{font:{size:11},color:"#666",stepSize:Math.ceil(n/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e},afterDataLimits:e=>e.max*=1.1,grid:{color:"rgba(0,0,0,0.05)"}}}},plugins:[ChartDataLabels]})}function renderProgramChart(e){let t=document.getElementById("programChart"),a=document.getElementById("top_program");if(!t)return;let r=e.tagFrequency||{},l=[["MSc AI UMEF",r["Msc_AI UMEF"]||0],["MBA UMEF",r["MBA UMEF"]||0],["EMBA UMEF",r["EMBA UMEF"]||0],["BBA",r.BBA||0],["DBA",r.DBA||0],].filter(([e,t])=>t>0);if(!l.length){a&&(a.textContent="-"),window.programChartInstance&&(window.programChartInstance.destroy(),window.programChartInstance=null);return}let o=l.map(([e])=>e),i=l.map(([e,t])=>t),n=Math.max(...i),s=i.map(e=>e===n?"#ffa900":"#d9d9d9");a&&(a.textContent=o[i.indexOf(n)]);let c=window.programChartInstance;if(c){let d=c.data.datasets[0];c.data.labels=o,d.data=i,d.backgroundColor=s,d.borderColor=s,c.options.animation.duration=300,c.update("none");return}window.programChartInstance=new Chart(t,{type:"bar",data:{labels:o,datasets:[{data:i,backgroundColor:s,borderColor:s,borderWidth:1,borderRadius:6},]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!1},tooltip:{intersect:!1,animation:!1,callbacks:{label:e=>`${e.parsed.y.toLocaleString()} leads`}},datalabels:{anchor:"end",align:"end",color:"#333",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{display:!1},ticks:{color:"#555",font:{size:12}}},y:{beginAtZero:!0,ticks:{color:"#666",font:{size:11},stepSize:Math.ceil(n/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e},grid:{color:"rgba(0,0,0,0.05)"}}}},plugins:[ChartDataLabels]})}function renderLeadQualityMeter(e){if(!e?.byTag)return;let t=Object.values(e.byTag).flat().length,a=e.byTag.Needed?.length||0,r=e.byTag.Considering?.length||0,l=a+r,o=t?(l/t*100).toFixed(2):0,i=t?(a/t*100).toFixed(1):0,n=t?(r/t*100).toFixed(1):0,s=document.querySelector(".semi-donut"),c=s?.querySelector(".frequency_number"),d=document.querySelector(".dom_frequency_label_impression"),u=document.querySelector(".dom_frequency_label_reach"),p=document.querySelector(".frequency_number_label");if(s){s.style.setProperty("--percentage",o);let g="#ffa900";o>=40?g="#00b148":o<=20&&(g="#e17055"),s.style.setProperty("--fill",g)}if(c&&(c.innerHTML=`<span>${o}%</span><span>(${l})</span>`),d&&(d.textContent=`${i}%`),u&&(u.textContent=`${n}%`),p){let[m,$]=p.querySelectorAll("p");m&&(m.textContent="0"),$&&($.textContent=`${t}`)}}function renderLeadTrendChart(e,t=currentTagFilter){currentTagFilter=t;let a=qsc("#leadTrendChart");if(!a)return;let r=Object.keys(e.byDate).sort();if(!r.length)return;let l=Array(r.length),o=Array(r.length);for(let i=0;i<r.length;i++){let n=e.byDate[r[i]];l[i]=n.total||0,o[i]=n[t]||0}let s=l.length?Math.max.apply(null,l):0,c=window._gradTotal,d=window._gradTag,u=a.getContext("2d");c&&d||((c=u.createLinearGradient(0,0,0,400)).addColorStop(0,"rgba(255,171,0,0.8)"),c.addColorStop(1,"rgba(255,171,0,0.1)"),(d=u.createLinearGradient(0,0,0,400)).addColorStop(0,"rgba(38,42,83,0.8)"),d.addColorStop(1,"rgba(38,42,83,0.1)"),window._gradTotal=c,window._gradTag=d),scheduleIdle(()=>{updateLeadCounters(e,currentTagFilter),renderLeadTagChart(e)},60);let p=window.leadChartInstance;if(p){if(arraysEqual(p.data.labels,r)&&arraysEqual(p.data.datasets[0].data,l)&&arraysEqual(p.data.datasets[1].data,o)&&p.data.datasets[1].label===`${t} Leads`)return;p.data.labels=r,p.data.datasets[0].data=l,p.data.datasets[1].data=o,p.data.datasets[1].label=`${t} Leads`,p.options.animation.duration=300,p.update("active");return}window.leadChartInstance=new Chart(a,{type:"line",data:{labels:r,datasets:[{label:"Total Leads",data:l,backgroundColor:c,borderColor:"#ffab00",fill:!0,tension:0,pointRadius:0,borderWidth:2},{label:`${t} Leads`,data:o,backgroundColor:d,borderColor:"#262a53",fill:!0,tension:0,pointRadius:0,borderWidth:2},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:300},plugins:{legend:{position:"top",align:"end"},tooltip:{callbacks:{label(e){let t=l[e.dataIndex]||0,a=e.parsed.y||0,r=t>0?(a/t*100).toFixed(1):0;return`${e.dataset.label}: ${a.toLocaleString()} leads (${r}%)`}}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#444",autoSkip:!0,maxTicksLimit:8}},y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#666",stepSize:Math.ceil((s||1)/4)},afterDataLimits:e=>e.max*=1.1}}},plugins:[ChartDataLabels]})}function getColorFromName(e){let t=0;for(let a=0;a<e.length;a++)t=e.charCodeAt(a)+((t<<5)-t);let r=Math.abs(t)%360,l=65+t%10,o=55+t%10,i=(1-Math.abs(2*o/100-1))*(l/100),n=i*(1-Math.abs(r/60%2-1)),s=o/100-i/2,[c,d,u]=[0,0,0];r<60?[c,d,u]=[i,n,0]:r<120?[c,d,u]=[n,i,0]:r<180?[c,d,u]=[0,i,n]:r<240?[c,d,u]=[0,n,i]:r<300?[c,d,u]=[n,0,i]:[c,d,u]=[i,0,n];let p=e=>Math.round((e+s)*255).toString(16).padStart(2,"0");return`${p(c)}${p(d)}${p(u)}`}function initSaleDetailClose(){let e=document.querySelector(".dom_dashboard"),t=document.querySelector(".sale_report"),a=document.querySelector(".dom_toplist_wrap .dom_toplist.sale");if(!e||!t||!a)return;let r=t.querySelector(".sale_report_close");r&&"1"!==r.dataset.bound&&(r.dataset.bound="1",r.addEventListener("click",()=>{e.classList.remove("sale_detail");let t=localStorage.getItem("selectedAccount")||"Total Data",r=RAW_DATA;"VTCI"===t?r=RAW_DATA.filter(e=>"VTCI"===e.CustomField16Text?.trim().toUpperCase()):"IDEAS"===t&&(r=RAW_DATA.filter(e=>"IDEAS"===e.CustomField16Text?.trim().toUpperCase())),processAndRenderAll(r),a.querySelectorAll("li").forEach(e=>e.classList.remove("active")),console.log("\uD83D\uDD04 Dashboard reset v·ªÅ tr·∫°ng th\xe1i g·ªëc")}))}function renderToplistBySale(e){renderSaleDropdown();let t=document.querySelector(".dom_toplist_wrap .dom_toplist.sale"),a=document.querySelector(".dom_dashboard"),r=document.querySelector(".sale_report"),l=document.querySelector(".dom_date");if(!t||!e?.byOwner||!a||!r||!l)return;ORIGINAL_DATA||(ORIGINAL_DATA=RAW_DATA);let o=Object.entries(e.byOwner).map(([e,t])=>{let a=t.total||0,r=t.tags?.Needed?.count||0,l=t.tags?.Considering?.count||0,o=r+l,i=a>0?(o/a*100).toFixed(1):0;return{key:e,total:a,quality:o,ratio:+i}}).sort((e,t)=>t.total-e.total);t.innerHTML="",o.forEach(e=>{let a=e.key.replace(/\(NV.*?\)/gi,"").trim(),r="rgb(0, 177, 72)";e.ratio<20?r="rgb(225, 112, 85)":e.ratio<40&&(r="rgb(255, 169, 0)");let l=getColorFromName(a),o=`https://ui-avatars.com/api/?name=${encodeURIComponent(a)}&background=${l}&color=fff&bold=true`,i=`
      <li data-owner="${a}">
        <p><img src="${o}" class="avatar"/><span>${a}</span></p>
        <p><i class="fa-solid fa-user"></i><span class="total_lead">${e.total}</span></p>
        <p><i class="fa-solid fa-user-graduate"></i><span class="quality_lead">${e.quality}</span></p>
        <p class="toplist_percent" style="color:${r}; background:rgba(${r.replace("rgb(","").replace(")","")},0.1)">${e.ratio}%</p>
        <p class="toplist_more" title="L·ªçc theo ${a}"><i class="fa-solid fa-magnifying-glass-chart main_clr"></i></p>
      </li>`;t.insertAdjacentHTML("beforeend",i)}),t.querySelectorAll(".toplist_more").forEach(e=>{e.addEventListener("click",e=>{setSourceActive();let o=e.currentTarget.closest("li"),i=o.dataset.owner;if(!i)return;let n=GROUPED.byOwner[i].leads;processAndRenderAll(n),a.classList.add("sale_detail");let s=r.querySelector("img"),c=r.querySelector(".dom_selected"),d=r.querySelector(".sale_report_calender");s&&(s.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(i)}&background=3381c1&color=fff&bold=true`),c&&(c.innerText=i),d&&(d.innerText=l.innerText);let u=r.querySelector(".dom_select_show");renderSaleDropdown(u),t.querySelectorAll("li").forEach(e=>e.classList.remove("active")),o.classList.add("active")})})}function filterBySaleExact(e){let t=processCRMData(RAW_DATA);if(!t?.byOwner)return[];let a=Object.keys(t.byOwner).filter(t=>t.replace(/\(NV.*?\)/gi,"").trim()===e);return a.flatMap(e=>t.byOwner[e].leads||[])}function renderSaleDropdown(){let e=RAW_DATA,t=localStorage.getItem("selectedAccount")||"Total Data";"VTCI"===t?e=RAW_DATA.filter(e=>"VTCI"==e.CustomField16Text?.trim().toUpperCase()):"IDEAS"===t&&(e=RAW_DATA.filter(e=>"IDEAS"==e.CustomField16Text?.trim().toUpperCase()));let a=processCRMData(e),r=document.querySelector(".sale_report"),l=r.querySelector(".saleperson_detail .dom_select_show");l.innerHTML="",Object.keys(a.byOwner).forEach(e=>{let t=e.replace(/\(NV.*?\)/gi,"").trim(),a=getColorFromName(t),r=`https://ui-avatars.com/api/?name=${encodeURIComponent(t)}&background=${a}&color=fff&bold=true`,o=document.createElement("li");o.dataset.owner=t,o.innerHTML=`<img src="${r}"/><span>${t}</span>`,o.addEventListener("click",()=>{let e=filterBySaleExact(t);processAndRenderAll(e);let a=l.closest(".sale_report"),o=a.querySelector("img"),i=a.querySelector(".dom_selected");o&&(o.src=r),i&&(i.innerText=t)}),l.appendChild(o)})}function setupCompareDropdowns(){let e=document.querySelectorAll(".dom_select.compare");e.length&&e.forEach(e=>{let t=e.querySelector(".flex"),a=e.querySelector(".dom_select_show"),r=e.querySelector(".dom_selected"),l=e.querySelector(".apply_custom_date"),o=e.querySelector(".custom_date"),i=a.querySelectorAll("li");t.onclick=e=>{e.stopPropagation(),document.querySelectorAll(".dom_select_show").forEach(e=>e!==a&&e.classList.remove("active")),a.classList.toggle("active")},i.forEach(t=>{t.onclick=l=>{l.stopPropagation();let n=t.dataset.date;if("custom_range"===n){i.forEach(e=>e.classList.remove("active")),t.classList.add("active"),o.classList.add("show");return}i.forEach(e=>e.classList.remove("active")),t.classList.add("active"),o.classList.remove("show");let s=t.querySelector("span:last-child").textContent.trim();r.textContent=s,e.classList.contains("compare_1")?(compareState.range1=n,compareState.custom1=null):e.classList.contains("compare_2")&&(compareState.range2=n,compareState.custom2=null),a.classList.remove("active")}}),l&&(l.onclick=t=>{t.stopPropagation();let l=e.querySelector("#start").value,i=e.querySelector("#end").value;return l&&i?new Date(i)<=new Date(l)?alert("‚ö†Ô∏è Ng\xe0y k·∫øt th\xfac ph·∫£i sau ng\xe0y b·∫Øt ƒë·∫ßu!"):void(r.textContent="Custom Date",o.classList.remove("show"),e.classList.contains("compare_1")?(compareState.range1="custom",compareState.custom1={from:l,to:i}):e.classList.contains("compare_2")&&(compareState.range2="custom",compareState.custom2={from:l,to:i}),a.classList.remove("active")):alert("‚ö†Ô∏è Vui l\xf2ng ch·ªçn ƒë·ªß ng\xe0y b·∫Øt ƒë·∫ßu v\xe0 k·∫øt th\xfac!")}),document.addEventListener("click",t=>{e.contains(t.target)||a.classList.remove("active")})})}async function loadCompareData(e,t){let a=document.querySelector(".dom_compare");if(!a)return alert("‚ö†Ô∏è Kh\xf4ng t\xecm th·∫•y v\xf9ng compare!");let r=localStorage.getItem("selectedAccount")||"Total Data";console.log("\uD83D\uDCCA Loading compare data for:",r);try{let[l,o]=await Promise.all([fetchLeads(e.from,e.to),fetchLeads(t.from,t.to),]),i=filterByAccount(l,r),n=filterByAccount(o,r),s=processCRMData(i),c=processCRMData(n),d=summarizeCompareData(i,s),u=summarizeCompareData(n,c);renderCompareBoxes(a,d,u),renderCompareTrendChart(s,c),renderDegreeTableCompare(s,c),renderProgramChartCompare(s,c),renderLeadSaleCompare(s,c),renderLeadTagChartCompare(s,c),renderLeadTagChartBySaleCompare(s,c),setupLeadTagChartBySaleCompare(s,c),renderCompareToplist(s,c),window.CRM_DATA_1=i,window.CRM_DATA_2=n,window.GROUPED_COMPARE_1=s,window.GROUPED_COMPARE_2=c,console.log("‚úÖ Compare data loaded & cached for:",r)}catch(p){console.error("‚ùå L·ªói khi t·∫£i Compare:",p),alert("L·ªói khi t·∫£i d·ªØ li·ªáu so s\xe1nh!")}finally{}}document.addEventListener("click",e=>{let t=e.target.closest(".sale_report .sale_report_close")||e.target.closest(".dom_overlay");if(t){let a=document.querySelector(".dom_dashboard");a&&(a.classList.remove("sale_detail_ads","sale_detail"),processAndRenderAll(RAW_DATA)),setSourceActive();return}let r=e.target.closest(".ai_report");if(r){let l=document.querySelector(".dom_ai_report");if(!l)return;generateAdvancedReport(CRM_DATA),l.classList.add("active");let o=document.querySelector(".dom_ai_report_content");o.scrollTop=0,setTimeout(()=>{let e=l.querySelectorAll(".fade_in_item");e.forEach((e,t)=>{setTimeout(()=>e.classList.add("show"),300*t)})},3e3);return}let i=e.target.closest(".ai_report_sale"),n=e.target.closest(".ai_report_compare");if(n){let s=document.querySelector(".dom_ai_report");if(!s)return;generateAdvancedCompareReport(),s.classList.add("active");let c=document.querySelector(".dom_ai_report_content");c.scrollTop=0;return}if(i){let d=document.querySelector(".dom_ai_report");if(!d)return;let u=document.querySelector(".saleperson_detail .dom_selected"),p=u?.textContent?.trim()||VIEW_DATA[0]?.OwnerIDText||"Sale";generateSaleReportAI(VIEW_DATA,p),d.classList.add("active");let g=document.querySelector(".dom_ai_report_content");g.scrollTop=0;return}let m=e.target.closest(".dom_ai_report_close");if(m){let $=document.querySelector(".dom_ai_report");$&&($.classList.add("closing"),$.addEventListener("animationend",()=>{$.classList.remove("active","closing")},{once:!0}))}}),document.addEventListener("click",async e=>{}),document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelector(".button_group .btn-source"),t=document.querySelector(".button_group .btn-campaign");e&&t&&(e.addEventListener("click",()=>{e.classList.add("active"),t.classList.remove("active"),renderToplist(GROUPED,"default")}),t.addEventListener("click",()=>{t.classList.add("active"),e.classList.remove("active"),renderToplist(GROUPED,"campaign")}))});let compareLoaded=!1,lastCompareAccount=null;function updateCompareDateUI(e,t){let a=e=>{let t=new Date(e);return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()}`},r=document.getElementById("compare_date");r&&(r.innerHTML=`
      <span><b><i class="fa-solid fa-circle"></i> Range 1:</b> ${a(e.from)} ‚Üí ${a(e.to)}</span>
      <span><b><i class="fa-solid fa-circle"></i> Range 2:</b> ${a(t.from)} ‚Üí ${a(t.to)}</span>
    `);let l=document.querySelector(".btn-source.rang1"),o=document.querySelector(".btn-source.rang2");l&&(l.innerHTML=`<i class="fa-solid fa-circle"></i> ${a(e.from)} ‚Üí ${a(e.to)}`),o&&(o.innerHTML=`<i class="fa-solid fa-circle"></i> ${a(t.from)} ‚Üí ${a(t.to)}`)}function summarizeCompareData(e,t){if(!e?.length)return{total:0,qualifiedPct:0,needed:0,considering:0};let a=e.length,r=t.byTag?.Needed?.length||0,l=t.byTag?.Considering?.length||0,o=a?((r+l)/a*100).toFixed(1):0;return{total:a,qualifiedPct:o,needed:r,considering:l}}function renderCompareBoxes(e,t,a){let r=e.querySelectorAll(".dom_inner.w25.box_shadow.chart");if(r.length<2)return;let l=e=>({name:e?.name||"Unknown",total:e?.total??0,qualifiedPct:e?.qualifiedPct??0,needed:e?.needed??0,considering:e?.considering??0}),o=(e,t)=>{let a=e-t,r=0===t?0:(a/t*100).toFixed(1);return{pct:r,sign:a>0?"up":a<0?"down":"equal",delta:a}},i=(e,t,a,r=!1)=>{if(!e)return;let{pct:l,sign:o}=a,i=r?`${t}%`:t.toLocaleString();e.innerHTML=`
      <span class="val">${i}</span>
      <span class="pct ${o}">
        ${"up"===o?'<i class="fa-solid fa-caret-up"></i>':"down"===o?'<i class="fa-solid fa-caret-down"></i>':""}${l>0?"+":""}${l}%
      </span>
    `},n=(e,t,a,r=!1,n=!1)=>{let c=e.querySelector(".chart_title")||e.querySelector("h3"),d=e.querySelector("ul li:nth-of-type(1) p"),u=e.querySelector("ul li:nth-of-type(2) p"),p=e.querySelector("ul li:nth-of-type(3) p"),g=e.querySelector("ul li:nth-of-type(4) p"),m=l(t),$=l(a);c&&(c.textContent=m.name),n?e.classList.add("inactive"):e.classList.remove("inactive"),d.innerHTML=`<span class="val">${m.total.toLocaleString()}</span>`;let h=r?-1:1;i(u,m.qualifiedPct,s(o(m.qualifiedPct,$.qualifiedPct),h),!0),i(p,m.needed,s(o(m.needed,$.needed),h)),i(g,m.considering,s(o(m.considering,$.considering),h))},s=(e,t)=>{if(1===t)return e;let a="up"===e.sign?"down":"down"===e.sign?"up":"equal";return{pct:e.pct,sign:a,delta:-e.delta}},c=e=>({name:e?.name||"Unknown",total:0,qualifiedPct:0,needed:0,considering:0}),d=t?l(t):null,u=a?l(a):null;!d&&u&&(d=c(u)),!u&&d&&(u=c(d)),n(r[0],d,u,!1,!t),n(r[1],u,d,!a),((e,t,a,r)=>{e.classList.remove("up","down","equal"),t.classList.remove("up","down","equal");let l=a?.total??0,o=r?.total??0;l>o?(e.classList.add("up"),t.classList.add("down")):l<o?(e.classList.add("down"),t.classList.add("up")):(e.classList.add("equal"),t.classList.add("equal"))})(r[0],r[1],d,u)}function renderCompareTrendChart(e,t){let a=document.getElementById("leadTrendChartCompare");if(!a)return;let r=e.byDate||{},l=t.byDate||{},o=e=>{if(!e&&0!==e)return"";let t=new Date(e);return isNaN(t.getTime())?String(e).split(/\s+/)[0].trim():t.toISOString().slice(0,10)},i={};for(let n of Object.keys(r)){let s=o(n);i[s]=r[n]}let c={};for(let d of Object.keys(l)){let u=o(d);c[u]=l[d]}let p=new Set([...Object.keys(i),...Object.keys(c)]),g=Array.from(p).sort((e,t)=>new Date(e)-new Date(t)),m=e=>{if(!e)return 0;for(let t of["total","Total","count","Count","total_leads","totalLead",])if(void 0!==e[t]&&null!==e[t]){let a=Number(e[t]);return isNaN(a)?0:a}if(Array.isArray(e))return e.length;if(void 0!==e.length){let r=Number(e.length);return isNaN(r)?0:r}return 0},$=g.map(e=>m(i[e])),h=g.map(e=>m(c[e]));h.every(e=>0===e)&&(console.warn("renderCompareTrendChart: all counts2 are 0 ‚Äî ki·ªÉm tra map2 v\xe0 raw keys:"),console.table({datesSample:g.slice(0,10),map2KeysSample:Object.keys(c).slice(0,10),rawByDate2KeysSample:Object.keys(l).slice(0,10)}));let f=a.getContext("2d");if(!window._gradRange1||!window._gradRange2){let y=f.createLinearGradient(0,0,0,400);y.addColorStop(0,"rgba(255, 171, 0, 0.8)"),y.addColorStop(1,"rgba(255, 171, 0, 0.1)");let b=f.createLinearGradient(0,0,0,400);b.addColorStop(0,"rgba(38,42,83, 0.8)"),b.addColorStop(1,"rgba(38,42,83, 0.1)"),window._gradRange1=y,window._gradRange2=b}let _=window.compareChartInstance;if(_){if(arraysEqual(_.data.labels,g)&&arraysEqual(_.data.datasets[0].data,$)&&arraysEqual(_.data.datasets[1].data,h))return;_.data.labels=g,_.data.datasets[0].data=$,_.data.datasets[1].data=h,_.options.animation.duration=300,_.update("active");return}window.compareChartInstance=new Chart(a,{type:"line",data:{labels:g,datasets:[{label:"Range 1",data:$,backgroundColor:window._gradRange1,borderColor:"#ffab00",fill:!0,tension:0,pointRadius:3,borderWidth:2},{label:"Range 2",data:h,backgroundColor:window._gradRange2,borderColor:"#262a53",fill:!0,tension:0,pointRadius:3,borderWidth:2},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:400},plugins:{legend:{position:"top",align:"end"},tooltip:{callbacks:{label:e=>`${e.dataset.label}: ${e.parsed.y.toLocaleString()} leads`}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},color:"#333",formatter:e=>e>0?e.toLocaleString():""}},scales:{x:{grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#444",autoSkip:!0,maxTicksLimit:8}},y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#666",stepSize:Math.ceil(Math.max(...$,...h,0)/4)},afterDataLimits:e=>e.max*=1.1}}},plugins:[ChartDataLabels]})}function renderDegreeTableCompare(e,t){let a=document.getElementById("degreeChartCompare");if(!a)return;let r=Array.isArray(e)?e:Object.values(e.byOwner||{}).flatMap(e=>e.leads||[]),l=Array.isArray(t)?t:Object.values(t.byOwner||{}).flatMap(e=>e.leads||[]);if(!r.length&&!l.length){a.innerHTML="<p style='text-align:center;color:#999'>Kh\xf4ng c\xf3 d·ªØ li·ªáu</p>";return}let o=countDegrees(r),i=countDegrees(l),n=Object.keys(o),s=n.map(e=>{let t=o[e]||0,a=i[e]||0,r=t-a,l=r>0?`<i class="fa-solid fa-caret-up"></i> <span class="up">+${r}</span>`:r<0?`<i class="fa-solid fa-caret-down"></i> <span class="down">${r}</span>`:"-";return`
        <tr class="${r>0?"up":r<0?"down":""}">
          <td>${e}</td>
          <td style="text-align:center">${t}</td>
          <td style="text-align:center">${a}</td>
          <td style="text-align:center">${l}</td>
        </tr>
      `}).join("");a.innerHTML=`
    <table class="mini_table">
      <thead>
        <tr>
          <th>Tr\xecnh ƒë·ªô</th>
          <th>Range 1</th>
          <th>Range 2</th>
          <th>Bi·∫øn ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>${s}</tbody>
    </table>
  `}function renderProgramChartCompare(e,t){let a=document.getElementById("programChartCompare");if(!a)return;let r=e?.tagFrequency||{},l=t?.tagFrequency||{},o=[["MSc AI UMEF",r["Msc_AI UMEF"]||0,l["Msc_AI UMEF"]||0],["MBA UMEF",r["MBA UMEF"]||0,l["MBA UMEF"]||0],["EMBA UMEF",r["EMBA UMEF"]||0,l["EMBA UMEF"]||0],["BBA",r.BBA||0,l.BBA||0],["DBA",r.DBA||0,l.DBA||0],].filter(([e,t,a])=>t>0||a>0);if(!o.length){window.programChartCompareInstance&&(window.programChartCompareInstance.destroy(),window.programChartCompareInstance=null);return}let i=o.map(([e])=>e),n=o.map(([e,t])=>t),s=o.map(([e,t,a])=>a);if(window.programChartCompareInstance){let c=window.programChartCompareInstance;c.data.labels=i,c.data.datasets[0].data=n,c.data.datasets[1].data=s,c.update("none");return}window.programChartCompareInstance=new Chart(a,{type:"bar",data:{labels:i,datasets:[{label:"",data:n,backgroundColor:"rgba(255, 171, 0, 0.9)",borderSkipped:"bottom",borderRadius:{topLeft:6,topRight:6,bottomLeft:0,bottomRight:0}},{label:"",data:s,backgroundColor:"rgba(38,42,83, 0.9)",borderSkipped:"bottom",borderRadius:{topLeft:6,topRight:6,bottomLeft:0,bottomRight:0}},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:400,easing:"easeOutCubic"},plugins:{legend:{display:!1},tooltip:{mode:"index",intersect:!1,callbacks:{label:e=>`${0===e.datasetIndex?"Period 1":"Period 2"}: ${e.parsed.y} leads`}},datalabels:{anchor:"end",align:"end",color:"#333",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{display:!1},ticks:{color:"#555",font:{size:12}}},y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#666",font:{size:11},stepSize:Math.ceil(Math.max(...n,...s)/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e},afterDataLimits:e=>e.max*=1.1}}},plugins:[ChartDataLabels]})}function renderLeadTagChartCompare(e,t){let a=document.getElementById("leadTagChartCompare");if(!a||!e?.byTag||!t?.byTag)return;let r=new Set([...Object.keys(e.byTag),...Object.keys(t.byTag)]);if(!r.size)return;let l=Array.from(r),o=l.map(t=>e.byTag[t]?.length||0),i=l.map(e=>t.byTag[e]?.length||0),n=Math.max(...o,...i),s="rgba(255, 183, 40, 0.5)",c="rgba(78, 83, 136, 0.5)";if(window.leadTagChartCompareInstance){let d=window.leadTagChartCompareInstance;d.data.labels=l,d.data.datasets[0].data=o,d.data.datasets[1].data=i,d.options.scales.r.max=Math.ceil(n),d.options.scales.r.ticks.stepSize=Math.ceil(n/4)||1,d.options.scales.r.ticks.callback=e=>Number.isInteger(e)?e:"",d.update("none");return}window.leadTagChartCompareInstance=new Chart(a,{type:"radar",data:{labels:l,datasets:[{label:"Period 1",data:o,backgroundColor:"rgba(255, 183, 40, 0.36)",borderColor:s,borderWidth:2,pointBackgroundColor:s,pointRadius:4,pointHoverRadius:6},{label:"Period 2",data:i,backgroundColor:"rgba(78, 83, 136, 0.3)",borderColor:c,borderWidth:2,pointBackgroundColor:c,pointRadius:4,pointHoverRadius:6},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:500,easing:"easeOutCubic"},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.dataset.label}: ${e.parsed.r} leads`}},datalabels:{display:!1}},scales:{r:{beginAtZero:!0,min:0,max:n,ticks:{stepSize:Math.ceil(n/4)||1,color:"#555",showLabelBackdrop:!1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e},grid:{color:"rgba(0,0,0,0.08)"},angleLines:{color:"rgba(0,0,0,0.08)"},pointLabels:{font:{size:12,weight:"500"},color:"#333"}}}},plugins:[ChartDataLabels]})}function filterByAccount(e,t){if(!e?.length)return[];if("Total Data"===t)return e;let a=document.querySelectorAll("ul.box_shadow li[data-acc]"),r=Array.from(a).map(e=>e.getAttribute("data-acc").trim().toUpperCase());return r.includes(t.toUpperCase())?e.filter(e=>e.CustomField16Text?.trim().toUpperCase()===t.toUpperCase()):e}function renderLeadSaleCompare(e,t){if(!e?.byOwner||!t?.byOwner)return;let a=document.getElementById("leadSaleCompare");if(!a)return;let r=e.byOwner,l=t.byOwner,o=Array.from(new Set([...Object.keys(r),...Object.keys(l)])),i=[],n=[],s=[];for(let c of o){let d=c.replace(/\s*\(NV.*?\)/gi,"").trim();i.push(d),n.push(r[c]?.total||0),s.push(l[c]?.total||0)}let u=a.getContext("2d"),p="rgba(255, 171, 0, 0.8)",g="rgba(38, 42, 83, 0.8)";if(window.leadSaleCompareInstance){let m=window.leadSaleCompareInstance;m.data.labels=i,m.data.datasets[0].data=n,m.data.datasets[1].data=s,m.update();return}window.leadSaleCompareInstance=new Chart(u,{type:"bar",data:{labels:i,datasets:[{data:n,backgroundColor:p,borderColor:p.replace("0.8","1"),borderWidth:1,borderRadius:{topLeft:5,topRight:5}},{data:s,backgroundColor:g,borderColor:g.replace("0.8","1"),borderWidth:1,borderRadius:{topLeft:5,topRight:5}},]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},animation:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.y.toLocaleString()} leads`}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},formatter:e=>e>0?e:""}},scales:{x:{grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#444",autoSkip:!0,maxTicksLimit:10}},y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.05)"},ticks:{color:"#666",stepSize:Math.ceil(Math.max(...n,...s)/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e.toLocaleString()},afterDataLimits:e=>e.max*=1.1}}},plugins:[ChartDataLabels]})}function renderLeadTagChartBySaleCompare(e,t,a){let r=document.getElementById("leadTagChartbySaleCompare");if(!r)return;let l=(e,t)=>Object.keys(e.byOwner||{}).find(e=>e.replace(/\s*\(NV.*?\)/gi,"").trim()===t),o=l(e,a),i=l(t,a),n=e.byOwner[o]||{},s=t.byOwner[i]||{},c=[],d=[],u=[];for(let p of["Considering","Needed","Bad timing","Unqualified","Junk","New","Untag",]){let g=n.tags?.[p]?.count||0,m=s.tags?.[p]?.count||0;(g>0||m>0)&&(c.push(p),d.push(g),u.push(m))}let $="rgba(255, 171, 0, 0.8)",h="rgba(38, 42, 83, 0.8)";if(window.leadTagChartBySaleCompareInstance){let f=window.leadTagChartBySaleCompareInstance;f.data.labels=c,f.data.datasets[0].data=d,f.data.datasets[1].data=u,f.update();return}window.leadTagChartBySaleCompareInstance=new Chart(r,{type:"bar",data:{labels:c,datasets:[{data:d,backgroundColor:$,borderColor:$.replace("0.8","1"),borderWidth:1,borderRadius:{topLeft:6,topRight:6},barPercentage:.8,categoryPercentage:.5},{data:u,backgroundColor:h,borderColor:h.replace("0.8","1"),borderWidth:1,borderRadius:{topLeft:6,topRight:6},barPercentage:.8,categoryPercentage:.5},]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:300,easing:"easeOutQuad"},interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.y.toLocaleString()} leads`}},datalabels:{anchor:"end",align:"end",font:{weight:"bold",size:12},color:"#333",formatter:e=>e>0?e:""}},scales:{x:{grid:{color:"rgba(0,0,0,0.05)",drawTicks:!1,drawBorder:!1},ticks:{font:{size:12},color:"#555"}},y:{beginAtZero:!0,ticks:{font:{size:11},color:"#666",stepSize:Math.ceil(Math.max(...d,...u)/4)||1,callback:e=>e>=1e3?(e/1e3).toFixed(0)+"k":e.toLocaleString()},afterDataLimits:e=>e.max*=1.1,grid:{color:"rgba(0,0,0,0.05)"}}}},plugins:[ChartDataLabels]})}function setupLeadTagChartBySaleCompare(e,t){let a=document.querySelector(".dom_select.sale_tag_chart_compare");if(!a)return;let r=a.querySelector(".dom_select_show"),l=a.querySelector(".dom_selected");if(!e?.byOwner&&!t?.byOwner)return;let o=Array.from(new Set([...Object.keys(e.byOwner||{}),...Object.keys(t.byOwner||{}),])).map(e=>e.replace(/\s*\(NV.*?\)/gi,"").trim()),i=o[0];r.innerHTML=o.map(e=>`
      <li class="${e===i?"active":""}">
        <span class="radio_box ${e===i?"active":""}"></span>
        <span>${e}</span>
      </li>
    `).join(""),l.textContent=i,renderLeadTagChartBySaleCompare(e,t,i);let n=a.querySelector(".flex");n.dataset.bound||(n.dataset.bound="1",n.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".dom_select_show.active").forEach(e=>{e!==r&&e.classList.remove("active")}),r.classList.toggle("active")})),r.dataset.bound||(r.dataset.bound="1",r.addEventListener("click",a=>{let o=a.target.closest("li");if(!o)return;r.querySelectorAll("li").forEach(e=>e.classList.remove("active")),r.querySelectorAll(".radio_box").forEach(e=>e.classList.remove("active")),o.classList.add("active"),o.querySelector(".radio_box").classList.add("active");let i=o.querySelector("span:nth-child(2)").textContent.trim();l.textContent=i,renderLeadTagChartBySaleCompare(e,t,i),r.classList.remove("active")})),document._saleTagCompareOutside||(document.addEventListener("click",e=>{a.contains(e.target)||r.classList.remove("active")}),document._saleTagCompareOutside=!0)}function generateAdvancedCompareReport(){let e=document.querySelector(".dom_ai_report");if(!e)return console.warn("Kh\xf4ng t\xecm th·∫•y .dom_ai_report trong DOM.");let t=e.querySelector(".dom_ai_report_content"),a=e.querySelector("h3"),r=document.querySelector("#compare_date"),l=r?r.innerHTML.trim():"",o=localStorage.getItem("selectedAccount")||"Total Data";a&&(a.innerHTML=`
    <p><img src="./logotarget.png"><span>CRM COMPARE REPORT</span></p>
    ${l?`<p class="report_time" id="compare_render">${l}</p>`:""}
  `);let i=e=>{let t=(window.CRM_DATA_1||[]).filter(t=>(t.CustomField16Text||"").trim().toUpperCase()===e),a=(window.CRM_DATA_2||[]).filter(t=>(t.CustomField16Text||"").trim().toUpperCase()===e);return{org:e,grouped1:processCRMData(t),grouped2:processCRMData(a),data1:t,data2:a}},n=i("IDEAS"),s=i("VTCI"),c="";if("IDEAS"===o){let d=makeDeepCompareReport(n.grouped1,n.grouped2,n.data1,n.data2,"IDEAS");c=`
      <div class="ai_report_block ideas">
        <h4><img src="https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"/>IDEAS ‚Äì So s\xe1nh 2 k·ª≥</h4>
        <div class="ai_report_inner">${d}</div>
      </div>`}else if("VTCI"===o){let u=makeDeepCompareReport(s.grouped1,s.grouped2,s.data1,s.data2,"VTCI");c=`
      <div class="ai_report_block vtci">
        <h4><img src="https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"/>VTCI ‚Äì So s\xe1nh 2 k·ª≥</h4>
        <div class="ai_report_inner">${u}</div>
      </div>`}else{let p=makeDeepCompareReport(n.grouped1,n.grouped2,n.data1,n.data2,"IDEAS"),g=makeDeepCompareReport(s.grouped1,s.grouped2,s.data1,s.data2,"VTCI");c=`
      <div class="ai_report_block ideas">
        <h4><img src="https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"/>IDEAS ‚Äì So s\xe1nh 2 k·ª≥</h4>
        <div class="ai_report_inner">${p}</div>
      </div>
      <div class="ai_report_block vtci">
        <h4><img src="https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"/>VTCI ‚Äì So s\xe1nh 2 k·ª≥</h4>
        <div class="ai_report_inner">${g}</div>
      </div>`}t&&(t.innerHTML=c),setTimeout(()=>{let e=document.querySelector(".dom_ai_report");e&&e.querySelectorAll(".fade_in_item").forEach((e,t)=>{setTimeout(()=>e.classList.add("show"),300*t)})},3e3)}function renderCompareToplist(e,t){let a=document.querySelector(".compare_ads_1 .dom_toplist"),r=document.querySelector(".compare_ads_2 .dom_toplist");if(!a||!r)return console.warn("Kh\xf4ng t\xecm th·∫•y compare_ads_1 ho·∫∑c compare_ads_2.");a.innerHTML="",r.innerHTML="";let l=e=>{let t=[];if(!e?.byCampaign)return t;for(let[a,r]of Object.entries(e.byCampaign))for(let[l,o]of Object.entries(r))for(let[i,n]of Object.entries(o)){let s=n.length,c=n.filter(e=>"Needed"===e.TagMain).length,d=n.filter(e=>"Considering"===e.TagMain).length,u=c+d,p=s?u/s*100:0;t.push({key:`${a}|${l}|${i}`,campaign:a,source:l,medium:i,total:s,quality:u,ratio:+p.toFixed(1)})}return t},o=l(e),i=l(t),n=Array.from(new Set([...o.map(e=>e.key),...i.map(e=>e.key)])),s=e=>{let t=[{match:/facebook|fb/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Logo_de_Facebook.png/1200px-Logo_de_Facebook.png"},{match:/google/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png"},{match:/linkedin/i,url:"https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/LinkedIn_icon.svg/1024px-LinkedIn_icon.svg.png"},{match:/tiktok/i,url:"https://www.logo.wine/a/logo/TikTok/TikTok-Icon-White-Dark-Background-Logo.wine.svg"},{match:/Web IDEAS/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},{match:/Web VTCI/i,url:"https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp"},].find(t=>t.match.test(e));return t?t.url:"https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp"},c=n.map(e=>{let t=o.find(t=>t.key===e),a=i.find(t=>t.key===e),r=(t?.ratio||0)-(a?.ratio||0);return{key:e,a:t,b:a,diff:r,absDiff:Math.abs(r)}});c.sort((e,t)=>e.a&&e.b&&t.a&&t.b?t.a.total-e.a.total:e.a&&!e.b||!e.a&&t.b?1:t.absDiff-e.absDiff);let d=(e,t="")=>{let a="rgb(0, 177, 72)";e.ratio<20?a="rgb(225, 112, 85)":e.ratio<40&&(a="rgb(255, 169, 0)");let r=a.replace("rgb(","").replace(")","");return`
    <li class="${t}" data-campaign="${e.campaign}" data-source="${e.source}" data-medium="${e.medium}">
      <p><img src="${s(e.key)}"/><span>${e.campaign} - ${e.source} - ${e.medium}</span></p>
      <p><i class="fa-solid fa-user"></i><span>${e.total}</span></p>
      <p><i class="fa-solid fa-user-graduate"></i><span>${e.quality}</span></p>
      <p class="toplist_percent" style="color:${a}; background:rgba(${r},0.1)">${e.ratio}%</p>
    </li>`};c.forEach(e=>{let t=e.a,l=e.b;!t&&l&&(t={...l,total:0,quality:0,ratio:0}),!l&&t&&(l={...t,total:0,quality:0,ratio:0});let o="",i="";e.a||(o="inactive"),e.b||(i="inactive"),t&&l&&(t.total>l.total?(o+=" up",i+=" down"):t.total<l.total&&(o+=" down",i+=" up")),a.insertAdjacentHTML("beforeend",d(t,o.trim())),r.insertAdjacentHTML("beforeend",d(l,i.trim()))})}function makeDeepCompareReport(e,t,a,r,l="ORG"){if(!e?.byOwner||!t?.byOwner)return`<p class="warn fade_in_item delay-1">‚ö†Ô∏è Kh\xf4ng c\xf3 d·ªØ li·ªáu Compare cho ${l}.</p>`;let o=e=>isNaN(e)?"0":parseFloat(e).toFixed(1),i=e=>e>0?'<i class="fa-solid fa-caret-up" style="color:#00b248"></i>':e<0?'<i class="fa-solid fa-caret-down" style="color:#e17055"></i>':'<i class="fa-solid fa-minus" style="color:#999"></i>',n=new Map([["facebook","https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Logo_de_Facebook.png/1200px-Logo_de_Facebook.png",],["google","https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png",],["tiktok","https://www.logo.wine/a/logo/TikTok/TikTok-Icon-White-Dark-Background-Logo.wine.svg",],["linkedin","https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/LinkedIn_icon.svg/1024px-LinkedIn_icon.svg.png",],["zalo","https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Zalo_logo_2021.svg/512px-Zalo_logo_2021.svg.png",],["vtci","https://ideas.edu.vn/wp-content/uploads/2025/10/520821295_122209126670091888_6779497482843304564_n.webp",],["ideas","https://ideas.edu.vn/wp-content/uploads/2025/10/518336360_122227900856081421_6060559121060410681_n.webp",],]),s=(e="")=>{let t=e.toLowerCase();return t.includes("facebook")||t.includes("fb")?"facebook":t.includes("google")?"google":t.includes("tiktok")?"tiktok":t.includes("linkedin")?"linkedin":t.includes("zalo")?"zalo":t.includes("vtci")?"vtci":t.includes("ideas")||t.includes("web")?"ideas":null},c=(e="")=>{let t=s(e),a=t?n.get(t):null;if(a)return`<div class="camp_logo"><img src="${a}" alt="${e}" loading="lazy"></div>`;let r=0;for(let l=0;l<e.length;l++)r=e.charCodeAt(l)+((r<<5)-r);let o=Math.abs(r)%360,i=`hsl(${o},70%,65%)`;return`<div class="camp_logo" style="background:${i};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;border-radius:50%;width:40px;height:40px;">${e.slice(0,2).toUpperCase()}</div>`},d=e=>{let t=0;for(let a=0;a<e.length;a++)t=e.charCodeAt(a)+((t<<5)-t);return`hsl(${Math.abs(t)%360},70%,65%)`},u=e=>e.split(" ").map(e=>e[0]).join("").slice(0,2).toUpperCase(),p=a.length,g=r.length,m=p-g,$=g?(m/g*100).toFixed(1):0,h=(e.byTag?.Needed?.length||0)+(e.byTag?.Considering?.length||0),f=(t.byTag?.Needed?.length||0)+(t.byTag?.Considering?.length||0),y=p?(h/p*100).toFixed(1):0,b=g?(f/g*100).toFixed(1):0,_=y-b,v=new Set([...Object.keys(e.byOwner),...Object.keys(t.byOwner),]),C=[];v.forEach(a=>{let r=a.replace(/\s*\(NV.*?\)/gi,"").trim(),l=e.byOwner[a]||{},i=t.byOwner[a]||{},n=l.total||0,s=i.total||0,c=l.tags?.Needed?.count||0,d=l.tags?.Considering?.count||0,u=i.tags?.Needed?.count||0,p=i.tags?.Considering?.count||0,g=n?(c+d)/n*100:0,m=s?(u+p)/s*100:0;C.push({sale:r,totalCurr:n,totalPrev:s,diffTotal:n-s,rateCurr:o(g),ratePrev:o(m),rateDiff:o(g-m)})});let w=(e,t,a=!0)=>{let r=null;for(let l of e)0!==l[t]&&(!r||(a?l[t]>r[t]:l[t]<r[t]))&&(r=l);return r},T=w(C,"diffTotal",!0),k=w(C,"diffTotal",!1),S=w(C,"rateDiff",!0),A=w(C,"rateDiff",!1),L=/Needed|Considering/i,q=e=>{let t=[];for(let a in e.byCampaign){let r=e.byCampaign[a];for(let l in r){let o=r[l];for(let i in o){let n=o[i],s=n.length,c=n.filter(e=>L.test(e.TagMain)).length;t.push({campaign:a,source:l,medium:i,total:s,ratio:s?c/s*100:0})}}}return t},D=q(e),x=q(t),E=new Map;for(let I of D)E.set(I.campaign+I.source+I.medium,{a:I});for(let R of x){let F=R.campaign+R.source+R.medium,M=E.get(F)||{};M.b=R,E.set(F,M)}let O=[];E.forEach(e=>O.push({...e,diff:(e.a?.total||0)-(e.b?.total||0)}));let B=(e,t="diff",a=!0)=>{let r=null;for(let l of e)l[t]&&(!r||(a?l[t]>r[t]:l[t]<r[t]))&&(r=l);return r||{}},P=(e,t=!0)=>{let a=null;for(let r of e){let l=(r.a?.ratio||0)-(r.b?.ratio||0);0!==l&&(!a||(t?l>a.diff:l<a.diff))&&(a={...r,diff:l})}return a||{}},U=B(O,"diff",!0),N=B(O,"diff",!1),W=P(O,!0),H=P(O,!1),V=(e,t)=>{let a=new Set([...Object.keys(e||{}),...Object.keys(t||{})]),r=[];return a.forEach(a=>{let l=e[a]?.length||e[a]||0,o=t[a]?.length||t[a]||0,i=l-o,n=o?(i/o*100).toFixed(1):0;r.push({key:a,v1:l,v2:o,diff:i,pct:n})}),r},G=V(e.byTag,t.byTag),z=e?.tagFrequency||{},K=t?.tagFrequency||{},j=["Msc_AI UMEF","MBA UMEF","EMBA UMEF","BBA","DBA"].map(e=>{let t=z[e]||0,a=K[e]||0,r=t-a,l=a?(r/a*100).toFixed(1):0;return{key:e.replace(/_/g," "),v1:t,v2:a,diff:r,pct:l}}).filter(e=>e.v1>0||e.v2>0),Q={duoiCD:/(d∆∞·ªõi[\s_]*cao[\s_]*ƒë·∫≥ng|duoi[\s_]*cao[\s_]*dang)/i,caoDang:/(cao[\s_]*ƒë·∫≥ng|cao[\s_]*dang)/i,thpt:/thpt/i,sinhVien:/(sinh[\s_]*vi√™n|sinh[\s_]*vien|sinhvien)/i,cuNhan:/(c·ª≠[\s_]*nh√¢n|cu[\s_]*nhan)/i,thacSi:/(th·∫°c[\s_]*sƒ©|thac[\s_]*si)/i},Z=(e="")=>{let t=e.toLowerCase();return Q.duoiCD.test(t)?"D∆∞·ªõi cao ƒë·∫≥ng":Q.caoDang.test(t)?"Cao ƒë·∫≥ng":Q.thpt.test(t)?"THPT":Q.cuNhan.test(t)?"C·ª≠ nh\xe2n":Q.sinhVien.test(t)?"Sinh vi\xean":Q.thacSi.test(t)?"Th·∫°c sƒ©":"Kh\xe1c"},Y=(e=[])=>{let t={"D∆∞·ªõi cao ƒë·∫≥ng":0,THPT:0,"Cao ƒë·∫≥ng":0,"Sinh vi\xean":0,"C·ª≠ nh\xe2n":0,"Th·∫°c sƒ©":0,Kh√°c:0};for(let a of e){let r=a.Description||a.CustomField5Text||"",l=Z(r);t[l]++}return t},J=V(Y(a),Y(r)),X=(e,t,a,r=0)=>{if(!t?.length)return"";let l=t.sort((e,t)=>Math.abs(t.diff)-Math.abs(e.diff)).map(e=>`
        <tr>
          <td>${e.key}</td><td>${e.v1}</td><td>${e.v2}</td>
          <td>${e.diff>0?"+":""}${e.diff}</td>
          <td>${e.pct}% ${i(e.diff)}</td>
        </tr>`).join("");return`
      <div class="fade_in_item delay-${r}">
        <h6>${e}</h6>
        <table class="mini_table">
          <thead><tr><th>${a}</th><th>Range 1</th><th>Range 2</th><th>\xb1</th><th>%</th></tr></thead>
          <tbody>${l}</tbody>
        </table>
      </div>`},ee=`
    <li>${i(m)} T·ªïng lead ${m>0?"tƒÉng":"gi·∫£m"} (${o($)}%).</li>
    <li>${i(_)} T·ª∑ l·ªá Qualified ${_>0?"tƒÉng":"gi·∫£m"} (${o(_)}%).</li>
  `;return`
  <section class="ai_section fade_in_block">
    <h5 class="fade_in_item delay-1"><i class="fa-solid fa-chart-simple"></i> ${l} Overview</h5>
    <ul class="insight_list fade_in_item delay-2">
      <li><b>Total Leads:</b> ${p} vs ${g} (${o($)}%) ${i(m)}</li>
      <li><b>Qualified%:</b> ${y}% vs ${b}% (${o(_)}%) ${i(_)}</li>
    </ul>

    <h5 class="fade_in_item delay-3"><i class="fa-solid fa-user-tie"></i> Sales Summary</h5>
    <ul class="ai_sale_list fade_in_item delay-4">
      ${T?`<li><div class="sale_item"><div class="sale_avatar" style="background:${d(T.sale)}">${u(T.sale)}</div><div class="sale_info"><p><strong>TƒÉng m·∫°nh:</strong>${T.sale}</p><p>${T.totalCurr} vs ${T.totalPrev} leads ${i(T.diffTotal)}</p></div></div></li>`:""}
      ${k?`<li><div class="sale_item"><div class="sale_avatar" style="background:${d(k.sale)}">${u(k.sale)}</div><div class="sale_info"><p><strong>Gi·∫£m nhi·ªÅu:</strong>${k.sale}</p><p>${k.totalCurr} vs ${k.totalPrev} leads ${i(k.diffTotal)}</p></div></div></li>`:""}
      ${S?`<li><div class="sale_item"><div class="sale_avatar" style="background:${d(S.sale)}">${u(S.sale)}</div><div class="sale_info"><p><strong>%Qualified tƒÉng m·∫°nh:</strong>${S.sale}</p><p>${S.rateCurr}% vs ${S.ratePrev}% ${i(S.rateDiff)}</p></div></div></li>`:""}
      ${A?`<li><div class="sale_item"><div class="sale_avatar" style="background:${d(A.sale)}">${u(A.sale)}</div><div class="sale_info"><p><strong>%Qualified gi·∫£m m·∫°nh:</strong>${A.sale}</p><p>${A.rateCurr}% vs ${A.ratePrev}% ${i(A.rateDiff)}</p></div></div></li>`:""}
    </ul>

    <h5 class="fade_in_item delay-5"><i class="fa-solid fa-bullhorn"></i> Ads Channel Performance</h5>
    <ul class="ai_campaign_list fade_in_item delay-6">
      ${U.a?`<li><div class="camp_item">${c(U.a.source)}<div class="camp_info"><p><strong>Chi·∫øn d·ªãch tƒÉng m·∫°nh:</strong>${U.a.campaign}</p><p>${U.a.source}/${U.a.medium}</p></div><div class="camp_stats"><span>${o(U.a.total)} vs ${o(U.b?.total||0)} leads ${i(U.diff)}</span></div></div></li>`:""}
      ${N.a?`<li><div class="camp_item">${c(N.a.source)}<div class="camp_info"><p><strong>Chi·∫øn d·ªãch gi·∫£m m·∫°nh:</strong>${N.a.campaign}</p><p>${N.a.source}/${N.a.medium}</p></div><div class="camp_stats"><span>${o(N.a.total)} vs ${o(N.b?.total||0)} leads ${i(N.diff)}</span></div></div></li>`:""}
      ${W.a?`<li><div class="camp_item">${c(W.a.source)}<div class="camp_info"><p><strong>K\xeanh c\xf3 %Qualified tƒÉng m·∫°nh nh·∫•t:</strong>${W.a.campaign}</p><p>${W.a.source}/${W.a.medium}</p></div><div class="camp_stats"><span>${o(W.a.ratio)}% vs ${o(W.b?.ratio||0)}% ${i(W.diff)}</span></div></div></li>`:""}
      ${H.a?`<li><div class="camp_item">${c(H.a.source)}<div class="camp_info"><p><strong>K\xeanh c\xf3 %Qualified gi·∫£m m·∫°nh nh·∫•t:</strong>${H.a.campaign}</p><p>${H.a.source}/${H.a.medium}</p></div><div class="camp_stats"><span>${o(H.a.ratio)}% vs ${o(H.b?.ratio||0)}% ${i(H.diff)}</span></div></div></li>`:""}
    </ul>

    <h5 class="fade_in_item delay-7"><i class="fa-solid fa-graduation-cap"></i> Program & Degree</h5>
    ${X("Program Summary",j,"Program",8)}
    ${X("Degree Summary",J,"Degree",9)}

    <h5 class="fade_in_item delay-10"><i class="fa-solid fa-tag"></i> Tag Overview</h5>
    ${X("Lead Tag Summary",G,"Tag",11)}

    <h5 class="fade_in_item delay-12"><i class="fa-solid fa-lightbulb"></i> Insights</h5>
    <ul class="insight_list fade_in_item delay-13">${ee}</ul>
  </section>`}document.addEventListener("click",async e=>{let t=e.target.closest('[data-view="compare"]');if(!t)return;let a=localStorage.getItem("selectedAccount")||"Total Data";if(a!==lastCompareAccount&&(compareLoaded=!1,lastCompareAccount=a),compareLoaded)return;let r=getDateRange("last_7days"),l=getDateRange("previous_7days"),o=document.querySelector(".loading");o.classList.add("active"),updateCompareDateUI(r,l),await loadCompareData(r,l),o.classList.remove("active"),compareLoaded=!0}),document.addEventListener("click",async e=>{let t=e.target.closest("#compare_btn");if(!t)return;let a="custom"===compareState.range1&&compareState.custom1?compareState.custom1:getDateRange(compareState.range1),r="custom"===compareState.range2&&compareState.custom2?compareState.custom2:getDateRange(compareState.range2),l=new Date("2025-10-01");if(new Date(a.to)<l||new Date(r.to)<l){alert("‚ö†Ô∏è Ng\xe0y ph·∫£i sau 01/10/2025!");return}updateCompareDateUI(a,r),await loadCompareData(a,r)});
